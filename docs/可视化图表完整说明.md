# 🎨 系统可视化图表完整说明

本文档详细说明了房价分析系统中所有可视化图表的类型、用途和计算方法。

---

## 📊 图表总览

系统共包含 **34 个可视化图表**，分布在以下几个页面：

| 页面 | 图表数量 | 主要功能 |
|------|----------|----------|
| 首页 | 2 个 | 全国概览、数据分布 |
| 城市深度分析 | 12 个 | 单城市房价深度分析 |
| 全国对比分析 | 10 个 | 多城市横向对比 |
| AI房价预测 | 2 个 | 价格预测展示 |
| 3D房价地图 | 3 个 | 空间可视化 |

---

## 〇、首页 (home.html)

### 1. 🗺️ 全国房价均价地图

**图表类型**: 中国地图 (ECharts Map)

**数据来源**: `app.py` → `/api/province/price-map`

**计算方法**:
```
每省份独立计算：
- 平均单价 = AVG(该省所有成交单价)（元/㎡）
- 平均总价 = AVG(该省所有成交价)（万元）
- 成交量 = COUNT(该省成交记录)
```

**颜色映射**:
| 价格水平 | 颜色 |
|---------|------|
| 最低 | 绿色 |
| 中低 | 青柠 |
| 中等 | 黄色 |
| 中高 | 橙色 |
| 最高 | 红色 |

**统计卡片**:
- 最低均价省份
- 最高均价省份
- 全国平均单价 = AVG(各省平均单价)
- 价格差距倍数 = 最高单价 / 最低单价

---

### 2. 📊 全国数据分布饼图

**图表类型**: 环形图 (Chart.js Doughnut)

**数据来源**: 首页渲染时从各省数据统计

**计算方法**:
```
每省份：
- 数据量 = COUNT(该省成交记录)
- 占比 = 数据量 / 全国总数据量 × 100%
```

---

## 一、城市深度分析页面 (analysis.html)

### 1. 📈 月度价格趋势图 (Price Trend Chart)

**图表类型**: 面积折线图 (ECharts Line with Area)

**数据来源**: `housing_analyzer.py` → `analyze_price_trend()`

**计算方法**:
```
1. 按年月分组（年月 = 成交日期转换为 Period('M')）
2. 计算每月平均成交价：月均价 = SUM(成交价) / COUNT(成交)
3. 计算环比增长率：环比 = (当月均价 - 上月均价) / 上月均价 × 100%
```

**显示内容**:
- 月度平均成交价走势曲线
- 最高点/最低点标记 (markPoint)
- 平均值参考线 (markLine)
- 支持数据缩放 (dataZoom)

---

### 2. 📊 价格分布箱线图 (Price Boxplot)

**图表类型**: 箱线图 (ECharts Boxplot)

**数据来源**: `housing_analyzer.py` → `analyze_basic_statistics()`

**计算方法**:
```
最小值 (Min): 所有成交价中的最小值
Q1 (25分位数): 第25百分位的成交价
中位数 (Median): 第50百分位的成交价
Q3 (75分位数): 第75百分位的成交价
最大值 (Max): 所有成交价中的最大值
平均值 (Mean): SUM(成交价) / COUNT(成交)
标准差 (Std): √[Σ(xi - mean)² / n]
```

**名词解释**:
- **Q1/Q3**: 四分位数，将数据分成4等份的分界点
- **IQR (四分位距)**: Q3 - Q1，用于识别异常值

---

### 3. 🎯 投资综合评分雷达图 (Investment Radar)

**图表类型**: 雷达图 (ECharts Radar)

**数据来源**: `housing_analyzer.py` → `calculate_investment_index()`

**五个维度的计算方法**:

| 维度 | 权重 | 计算公式 |
|------|------|----------|
| 价格趋势 | 40% | (最近6月均价 - 之前6月均价) / 之前6月均价 × 100 |
| 成交量趋势 | 20% | (最近6月成交量 - 之前6月成交量) / 之前6月成交量 × 100 |
| 市场稳定性 | 40% | 100 / (1 + CV/10)，其中 CV = 标准差/均值 × 100 |
| 投资指数 | - | 加权平均后归一化到 0-100 |
| 市场活跃度 | - | 基于月均成交量评估 |

**名词解释**:
- **CV (变异系数, Coefficient of Variation)**: 标准差与均值的比值，衡量数据离散程度，CV 越小表示数据越稳定

**投资指数评级**:
- 80-100: 优秀
- 70-79: 良好  
- 60-69: 一般
- 50-59: 较差
- <50: 不建议

---

### 4. 💰 价格区间分布柱状图 (Price Range Distribution)

**图表类型**: 柱状图 (ECharts Bar)

**数据来源**: `housing_analyzer.py` → `analyze_price_range()`

**计算方法**:
```
价格区间划分:
- 100万以下: 0 ≤ 价格 < 100
- 100-200万: 100 ≤ 价格 < 200
- 200-300万: 200 ≤ 价格 < 300
- 300-500万: 300 ≤ 价格 < 500
- 500-800万: 500 ≤ 价格 < 800
- 800-1000万: 800 ≤ 价格 < 1000
- 1000万以上: 价格 ≥ 1000

每区间统计:
- 成交量 = COUNT(该区间内的成交)
- 占比 = 成交量 / 总成交量 × 100%
```

---

### 5. 🏠 户型面积分布图 (Area Distribution)

**图表类型**: 平滑曲线面积图 (ECharts Line with Area)

**数据来源**: `housing_analyzer.py` → `analyze_area_distribution()`

**计算方法**:
```
面积区间划分:
- 小户型: 0 ≤ 面积 < 50㎡
- 中小户型: 50 ≤ 面积 < 90㎡
- 中户型: 90 ≤ 面积 < 120㎡
- 中大户型: 120 ≤ 面积 < 150㎡
- 大户型: 150 ≤ 面积 < 200㎡
- 豪宅: 面积 ≥ 200㎡

每区间统计:
- 成交量 = COUNT(该区间内的成交)
- 平均价格 = AVG(该区间内的成交价)
- 占比 = 成交量 / 总成交量 × 100%
```

---

### 6. 🎻 价格分布小提琴图 (Price Violin)

**图表类型**: 箱线图变体 + 密度估计 (ECharts Boxplot with Density)

**数据来源**: `housing_analyzer.py` → `analyze_price_violin_data()`

**计算方法**:
```
基础统计:
- min, q1, median, q3, max: 同箱线图
- mean: 平均值
- std: 标准差

密度估计:
- 使用 numpy.histogram() 计算 30 个分箱的密度分布
- density[i] = count[i] / (total × bin_width)
- 采样最多 500 个点用于散点显示
```

**名词解释**:
- **小提琴图**: 结合了箱线图和密度图的优点，能同时展示数据的分布形状和统计特征

---

### 7. 🗺️ 区域-时间价格热力图 (District Heatmap)

**图表类型**: 热力图 (ECharts Heatmap)

**数据来源**: `housing_analyzer.py` → `analyze_district_heatmap_data()`

**计算方法**:
```
矩阵构建:
- 行 (Y轴): 各区域
- 列 (X轴): 各月份
- 值: 该区域该月的平均单价 (元/㎡)

颜色映射:
- 使用线性颜色梯度: 浅蓝 → 深蓝
- min_price 映射到最浅色
- max_price 映射到最深色
```

---

### 8. 📊 价格变化瀑布图 (Price Waterfall)

**图表类型**: 瀑布图/桥图 (ECharts Bar Stack)

**数据来源**: `housing_analyzer.py` → `analyze_price_waterfall_data()`

**计算方法**:
```
价格变化因素拆解:
- 起始价格: 首月均价
- 市场趋势: 总变化 × 40%
- 区域发展: 总变化 × 30%
- 政策影响: 总变化 × 20%
- 其他因素: 总变化 × 10%
- 当前价格: 末月均价

总变化 = 末月均价 - 首月均价
```

**名词解释**:
- **瀑布图**: 展示一个值如何从初始值经过多个中间步骤变化到最终值

---

### 9. 🏠 户型分析系列图表 (House Type Analysis)

包含 4 个子图表：

#### 9.1 户型分布饼图 (House Type Distribution Pie)
**计算方法**:
```
按户型分组统计:
- 成交量 = COUNT(该户型)
- 占比 = 成交量 / 总成交量 × 100%
取前 10 种户型显示
```

#### 9.2 户型平均价格柱状图 (House Type Price Bar)
**计算方法**:
```
每种户型统计:
- 平均总价 = AVG(成交价)
- 平均单价 = AVG(成交单价)
- 平均面积 = AVG(面积)
```

#### 9.3 按室数统计组合图 (Room Statistics)
**图表类型**: 柱状图 + 多折线图 (ECharts Mixed)

**计算方法**:
```
从户型字符串提取室数: 正则匹配 (\d+)室
按室数分组计算:
- 成交量 (柱状图)
- 平均总价 (折线)
- 平均单价 (折线)
- 平均面积 (折线)
```

#### 9.4 主流户型价格趋势 (House Type Trend)
**计算方法**:
```
取前 5 种主流户型
按月统计每种户型的:
- 月均总价
- 月均单价
```

---

### 10. 📊 市场波动性分析 (Volatility Analysis)

**显示类型**: 统计卡片

**数据来源**: `housing_analyzer.py` → `analyze_volatility()`

**计算方法**:
```
变异系数 (CV):
CV = (月均价标准差 / 月均价平均值) × 100%

价格波动幅度:
range = max(月均价) - min(月均价)
range_percent = range / mean(月均价) × 100%

稳定性评级:
- CV < 5%: 非常稳定
- 5% ≤ CV < 10%: 稳定
- 10% ≤ CV < 15%: 一般
- 15% ≤ CV < 20%: 波动较大
- CV ≥ 20%: 波动剧烈
```

---

### 11. 📈 年度同比分析表 (YoY Analysis)

**显示类型**: 数据表格

**数据来源**: `housing_analyzer.py` → `analyze_year_over_year()`

**计算方法**:
```
按年份分组统计:
- 平均成交价 = AVG(成交价)
- 平均单价 = AVG(成交单价)
- 成交量 = COUNT(成交)

同比计算:
- 价格同比 = (本年均价 - 上年均价) / 上年均价 × 100%
- 成交量同比 = (本年成交量 - 上年成交量) / 上年成交量 × 100%
```

**名词解释**:
- **同比 (YoY, Year over Year)**: 与去年同期相比的变化率

---

### 12. 🌸 季节性特征分析 (Seasonality Analysis)

**显示类型**: 统计卡片

**数据来源**: `housing_analyzer.py` → `analyze_seasonality()`

**计算方法**:
```
按季度统计:
- Q1 (1-3月), Q2 (4-6月), Q3 (7-9月), Q4 (10-12月)
- 每季度平均价格 = AVG(该季度成交价)
- 每季度成交量 = COUNT(该季度成交) / 季度年数

季节性指数:
seasonal_index = (季度均价 / 全年均价 - 1) × 100%
```

---

## 二、全国对比分析页面 (national_comparison.html)

### 13. 🏆 投资价值指数雷达图 (Investment Comparison Radar)

**图表类型**: 多数据系列雷达图 (Chart.js Radar)

**数据来源**: `national_comparator.py` → `compare_investment_scores()`

**计算方法**:
```
对每个城市计算:
- 总评分 = 投资指数 (0-100)
- 价格趋势 = 50 + price_trend_score
- 成交量趋势 = 50 + volume_trend_score
- 市场稳定性 = stability_score

所有城市按总评分排名
```

---

### 14. 💰 价格水平对比图 (Price Comparison Chart)

**图表类型**: 双Y轴柱状图 (Chart.js Bar)

**数据来源**: `national_comparator.py` → `compare_prices()`

**计算方法**:
```
左Y轴: 平均成交价 (万元)
右Y轴: 平均单价 (元/㎡)

附加统计:
- 价格差距 = max(各城市均价) - min(各城市均价)
- 价格倍数 = max(各城市均价) / min(各城市均价)

差距评级:
- 倍数 < 1.5: 差距较小
- 1.5 ≤ 倍数 < 2: 差距中等
- 2 ≤ 倍数 < 3: 差距较大
- 倍数 ≥ 3: 差距悬殊
```

---

### 15. 📏 城市平均面积对比图 (Area Comparison Chart)

**图表类型**: 柱状图 (Chart.js Bar)

**数据来源**: `national_comparator.py` → `compare_overview()`

**计算方法**:
```
每城市平均面积 = AVG(面积)

统计:
- 最大面积及所属城市
- 最小面积及所属城市
- 全国平均 = AVG(各城市平均面积)
- 面积差距 = 最大面积 - 最小面积
```

---

### 16. 📈 市场规模对比图 (Market Scale Chart)

**图表类型**: 柱状图 (Chart.js Bar)

**数据来源**: `national_comparator.py` → `compare_market_scale()`

**计算方法**:
```
每城市统计:
- 总成交量 = COUNT(成交)
- 总成交额 = SUM(成交价)
- 月均成交量 = 总成交量 / 月份数
- 日均成交量 = 总成交量 / 天数
- 市场份额 = 该城市成交量 / 全国成交量 × 100%
```

---

### 17. 📊 增长率对比图 (Growth Chart)

**图表类型**: 多折线图 (Chart.js Line)

**数据来源**: `national_comparator.py` → `compare_growth_rates()`

**计算方法**:
```
每城市每年的平均价格
连接形成各城市的价格趋势线

整体趋势判断:
- 所有城市均上涨: "全面上涨"
- 所有城市均下跌: "全面下跌"
- 混合: 根据平均增长判断 "整体上涨/下跌，局部分化"
```

---

### 18. 💹 市场稳定性对比卡片 (Volatility Cards)

**显示类型**: 城市卡片组

**数据来源**: `national_comparator.py` → `compare_volatility()`

**计算方法**:
```
每城市计算:
- CV (变异系数)
- 稳定性等级
- 风险等级

风险评级:
- CV < 10%: 低风险
- 10% ≤ CV < 15%: 中低风险
- 15% ≤ CV < 20%: 中等风险
- CV ≥ 20%: 较高风险
```

---

### 19. 💸 购房可负担性对比图 (Affordability Chart)

**图表类型**: 双Y轴柱状图 (Chart.js Bar)

**数据来源**: `national_comparator.py` → `compare_affordability()`

**计算方法**:
```
可负担房源定义: 成交价 ≤ 200万

每城市统计:
- 可负担比例 = COUNT(价格≤200万) / 总成交量 × 100%
- 中档比例 = COUNT(200<价格≤500万) / 总成交量 × 100%
- 高端比例 = COUNT(价格>500万) / 总成交量 × 100%
- 30%首付 = 平均成交价 × 30%

可负担性评级:
- >70%: 高可负担性
- 50-70%: 中等可负担性
- 30-50%: 低可负担性
- <30%: 较难负担
```

---

### 20. 🏠 全国户型分布对比图 (House Type Comparison Chart)

**图表类型**: 柱状图 (Chart.js Bar)

**数据来源**: `national_comparator.py` → `compare_house_types()`

**计算方法**:
```
统计各城市主流户型及占比
识别全国最常见户型 (出现在最多城市的主流户型)
按室数对比各城市平均价格
```

---

### 21. 📊 按室数价格对比图 (Room Price Comparison)

**图表类型**: 分组柱状图 (Chart.js Bar)

**计算方法**:
```
X轴: 室数 (1室, 2室, 3室...)
每个分组: 各城市该室数的平均价格
```

---

### 22. 🗺️ 区域特征对比卡片 (Regional Characteristics)

**显示类型**: 城市卡片组

**数据来源**: `national_comparator.py` → `analyze_regional_characteristics()`

**计算方法**:
```
每城市分析:
- 主力户型类型 (刚需型/改善型/豪宅型)
- 高价区域 Top 3 (按平均单价排序)
- 性价比区域 Top 3 (按平均单价升序)
- 最活跃区域 Top 5 (按成交量排序)
- 区域数量
```

---

## 三、AI房价预测页面 (price_prediction.html)

### 23. 📈 预测对比图表 (Prediction Chart)

**图表类型**: 多折线图 + 区间填充 (ECharts Line with Area Band)

**数据来源**: `price_predictor.py` → `generate_simple_prediction()` + AI预测

**计算方法**:

```
统计预测:
1. 计算最近6个月的价格变化趋势
2. avg_change = mean(相邻月份差值)
3. 预测价格 = 当前价格 + avg_change × (1 + random(-0.3, 0.3))

置信度递减:
confidence[i] = max(40, 90 - i × 8)

预测区间:
- range_low = predicted_price × 0.95
- range_high = predicted_price × 1.05

AI预测:
- 基于 DeepSeek-V3 模型
- 输入: 历史数据、市场因素、季节性特征
- 输出: 月度预测价格 + 置信区间 + 趋势判断
```

---

### 24. 📅 逐月预测时间线 (Timeline Grid)

**显示类型**: 时间线卡片组

**计算方法**:
```
每月显示:
- 月份
- 统计预测价格 ± 区间
- AI预测价格 (如有)
- 置信度进度条
- 与统计预测的差异
```

---

## 四、3D房价地图页面 (map_3d.html)

### 25. 🗺️ 3D柱状地图 (3D Bar Map)

**图表类型**: 3D柱状图 (ECharts GL Bar3D)

**数据来源**: `/api/city/{city}/map-3d-data`

**计算方法**:
```
每个区域:
- 位置: 区域中心坐标 (经纬度)
- 高度: 映射数据值 (价格/成交量/涨跌幅/单价)

视图模式:
1. 价格模式: 高度 = 平均成交价
2. 成交量模式: 高度 = 成交数量
3. 涨跌幅模式: 高度 = 价格变化百分比
4. 单价模式: 高度 = 平均单价

颜色映射:
低价 → 中价 → 高价
绿色 → 黄色 → 红色
```

---

### 26. 📊 信息面板 (Info Panel)

**显示类型**: 悬浮信息卡片

**显示内容**:
```
悬停区域显示:
- 区域名称
- 当前价格/成交量/涨跌幅/单价
- 与均值的对比
```

---

### 27. 🎨 颜色图例 (Legend Panel)

**显示类型**: 渐变色条 + 标签

**计算方法**:
```
线性颜色映射:
position = (value - min) / (max - min)
color = gradient(position)
  where gradient = [#10b981, #fbbf24, #ef4444]
```

---

## 五、核心计算指标汇总

### 统计学指标

| 指标 | 英文 | 计算公式 | 用途 |
|------|------|----------|------|
| 平均值 | Mean | Σx / n | 中心趋势 |
| 中位数 | Median | 第50百分位 | 抗异常值 |
| 标准差 | Std | √[Σ(x-μ)²/n] | 离散程度 |
| 变异系数 | CV | σ/μ × 100% | 相对离散度 |
| 四分位数 | Q1/Q3 | 第25/75百分位 | 分布范围 |
| 环比 | MoM | (本月-上月)/上月 | 短期变化 |
| 同比 | YoY | (本期-去年同期)/去年同期 | 年度变化 |

### 投资评估指标

| 指标 | 计算方法 | 权重 | 说明 |
|------|----------|------|------|
| 价格趋势分 | 6个月价格变化率 | 40% | 判断涨跌趋势 |
| 成交量趋势分 | 6个月成交量变化率 | 20% | 判断市场活跃度 |
| 稳定性分 | 100/(1+CV/10) | 40% | 判断波动风险 |
| 综合投资指数 | 加权平均后归一化 | - | 综合评估 |

---

## 六、技术实现

### 前端图表库

- **ECharts 5.4.3**: 主要图表库，用于趋势图、热力图、雷达图等
- **ECharts GL 2.0.9**: 3D 可视化扩展
- **Chart.js 4.4.0**: 辅助图表库，用于全国对比页面的简单图表

### 后端数据处理

- **Pandas**: 数据聚合、分组统计、时间序列处理
- **NumPy**: 数值计算、统计函数、密度估计

### 图表渲染模块

- `echarts_renderer.js`: ECharts 图表渲染器
- `analysis.js`: 城市分析页图表
- `national_comparison.js`: 全国对比页图表
- `map_3d.js`: 3D 地图可视化

---

## 五、AI购房策略规划页面 (strategy_planner.html)

### 1. 💪 购买力分析

**类型**: 数据统计卡片

**数据来源**: `strategy_analyzer.py` → `analyze_affordability()`

**计算方法**:
```
1. 可购面积 = 预算 × 10000 / 平均单价
2. 匹配房源 = 预算 ±20% 范围内的成交房源
3. 房源占比 = 匹配房源数 / 总成交数 × 100%
4. 预算分位数 = COUNT(成交价 ≤ 预算) / 总成交数 × 100%
```

**购买力评级标准**:
| 分位数 | 评级 |
|--------|------|
| < 25% | 经济型（入门级）|
| 25%-50% | 标准型（中低端）|
| 50%-75% | 舒适型（中高端）|
| > 75% | 高端型（高端市场）|

---

### 2. 🗺️ 区域推荐算法

**类型**: 多维度评分排序

**数据来源**: `strategy_analyzer.py` → `recommend_districts()`

**计算方法**:
```
1. 按区域分组统计：平均价格、中位价格、成交量
2. 性价比评分：可买面积 = 预算 × 10000 / 区域平均单价
3. 价格趋势 = (最近30%均价 - 最早30%均价) / 最早30%均价 × 100%
4. 筛选：成交量 ≥ 100 套
5. 排序：优先匹配期望区域，其次按可买面积降序
6. 返回 Top 5 区域
```

---

### 3. ⏰ 市场时机评估

**类型**: 综合评分模型

**数据来源**: `strategy_analyzer.py` → `assess_market_timing()`

**计算方法**:
```
基础指标：
- 价格变化 = (最近25%均价 - 最早25%均价) / 最早25%均价 × 100%
- 成交量变化 = (最近25%成交量 - 最早25%成交量) / 最早25%成交量 × 100%
- 波动性 (CV) = 标准差 / 均价 × 100%

评分算法（基准分50）：
- 价格下跌 > 5% → +20分（买入好时机）
- 价格上涨 > 5% → -20分（时机一般）
- 价格平稳 → +10分
- 成交量下降 > 10% → +10分（议价空间大）
- 成交量上升 > 10% → -10分（竞争激烈）
- 波动性 < 10% → +10分（市场稳定）
- 波动性 > 20% → -10分（风险较高）
```

**时机评级标准**:
| 评分 | 评级 | 建议 |
|------|------|------|
| ≥ 70 | 极佳时机 | 积极看房，果断出手 |
| 60-69 | 较好时机 | 可以看房，不必着急 |
| 50-59 | 适中时机 | 边看边等，挑选性价比 |
| 40-49 | 需谨慎 | 多观察，谨慎决策 |
| < 40 | 建议观望 | 暂缓购房，等待时机 |

---

### 4. 🏦 贷款方案计算

**类型**: 等额本息计算器

**数据来源**: `strategy_analyzer.py` → `calculate_loan_plan()`

**计算方法**:
```
默认参数：首付30%，30年，年利率4.2%

首付金额 = 总价 × 首付比例
贷款金额 = 总价 - 首付

月供（等额本息）= 贷款 × r × (1+r)^n / [(1+r)^n - 1]
其中：r = 年利率/12（月利率）, n = 贷款年限×12（总月数）

总利息 = 月供 × 总月数 - 贷款本金
总还款 = 贷款本金 + 总利息
```

> **等额本息**：每月还款金额固定，前期利息多、本金少，后期本金多、利息少。

---

### 5. 🤖 AI专业建议

**类型**: DeepSeek-V3 大语言模型生成

**数据来源**: `strategy_analyzer.py` → `_generate_ai_advice()`

**生成方法**:
```
输入数据：
- 用户画像（城市、预算、目的、家庭人数、急迫程度）
- 购买力分析（可买面积、匹配房源、预算分位数）
- 区域推荐（Top3区域的价格、趋势、成交量）
- 市场时机（评分、价格变化、波动性）

模型参数：
- Model: DeepSeek-V3
- Temperature: 0.7（适度创造性）
- Max Tokens: 500（约300字）

输出维度：
1. 综合购房策略
2. 户型面积建议
3. 区域选择指导
4. 风险提示
```

---

## 七、图表使用建议

### 按用户角色推荐

| 角色 | 推荐关注图表 |
|------|-------------|
| 首次购房者 | 价格趋势图、价格区间分布、户型分析、可负担性对比 |
| 改善型购房者 | 区域热力图、户型价格趋势、价格预测 |
| 投资顾问 | 投资雷达图、波动性分析、增长率对比、瀑布图 |

### 图表交互说明

- 大部分 ECharts 图表支持鼠标悬停查看详情
- 趋势图支持数据缩放 (拖拽/滚轮)
- 3D 地图支持旋转、缩放、时间线播放
- 点击 "AI分析此图表" 可获得 AI 对图表的深度解读

---

*文档更新时间: 2025年12月*

