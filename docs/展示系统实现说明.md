# å±•ç¤ºç³»ç»Ÿå®ç°è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜æˆ¿ä»·åˆ†æé¡µé¢çš„å±•ç¤ºç³»ç»Ÿæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼ŒåŒ…æ‹¬æ•°æ®æµã€æ¸²æŸ“æœºåˆ¶å’Œäº¤äº’åŠŸèƒ½ã€‚

## ğŸ”„ å®Œæ•´æ•°æ®æµç¨‹

```
ç”¨æˆ·è®¿é—®é¡µé¢ 
  â†“
å‰ç«¯ JavaScript åŠ è½½ (analysis.js)
  â†“
å‘é€ API è¯·æ±‚ â†’ /api/city/{city_name_en}/deep-analysis
  â†“
åç«¯å¤„ç† (app.py) â†’ HousingAnalyzer åˆ†ææ•°æ®
  â†“
è¿”å› JSON æ•°æ®
  â†“
å‰ç«¯æ¥æ”¶æ•°æ® â†’ å­˜å‚¨åˆ° analysisData å˜é‡
  â†“
è°ƒç”¨ renderAnalysis() â†’ æ¸²æŸ“æ‰€æœ‰ç»„ä»¶
  â†“
ç”¨æˆ·çœ‹åˆ°å®Œæ•´çš„åˆ†ææŠ¥å‘Š
```

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### 1. æ•°æ®è·å–å±‚

**æ–‡ä»¶**: `static/js/analysis.js` (ç¬¬ 9-69 è¡Œ)

```javascript
// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ
document.addEventListener('DOMContentLoaded', async function() {
    // 1. å‘é€è¯·æ±‚è·å–æ•°æ®
    const response = await fetch(`/api/city/${cityNameEn}/deep-analysis`);
    
    // 2. è§£æ JSON å“åº”
    const result = await response.json();
    
    // 3. å­˜å‚¨æ•°æ®å¹¶å¼€å§‹æ¸²æŸ“
    if (result.success && result.analysis) {
        analysisData = result.analysis;
        renderAnalysis();  // å¼€å§‹æ¸²æŸ“
    }
});
```

**å…³é”®ç‚¹**:
- ä½¿ç”¨ `fetch` API è¿›è¡Œå¼‚æ­¥è¯·æ±‚
- 30ç§’è¶…æ—¶ä¿æŠ¤
- é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

### 2. æ•°æ®æ¸²æŸ“å±‚

**æ–‡ä»¶**: `static/js/analysis.js` (ç¬¬ 71-114 è¡Œ)

`renderAnalysis()` å‡½æ•°æ˜¯æ ¸å¿ƒè°ƒåº¦å™¨ï¼ŒæŒ‰é¡ºåºæ¸²æŸ“å„ä¸ªéƒ¨åˆ†ï¼š

```javascript
function renderAnalysis() {
    // 1. æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
    document.getElementById('loading-analysis').style.display = 'none';
    document.getElementById('analysis-content').style.display = 'block';
    
    // 2. æ¸²æŸ“å„ä¸ªç»Ÿè®¡æ¨¡å—
    renderInvestmentIndex();      // æŠ•èµ„æŒ‡æ•°å¡ç‰‡
    renderBasicStats();            // åŸºç¡€ç»Ÿè®¡
    renderVolatility();            // æ³¢åŠ¨æ€§åˆ†æ
    renderMarketActivity();        // å¸‚åœºæ´»è·ƒåº¦
    renderYoY();                  // å¹´åº¦åŒæ¯”
    renderDistrictAnalysis();     // åŒºåŸŸåˆ†æ
    renderSeasonality();           // å­£èŠ‚æ€§åˆ†æ
    
    // 3. æ¸²æŸ“å›¾è¡¨ï¼ˆä½¿ç”¨ EChartsï¼‰
    renderPriceTrendECharts(...);  // ä»·æ ¼è¶‹åŠ¿å›¾
    renderPriceBoxPlot(...);       // ç®±çº¿å›¾
    renderInvestmentRadar(...);    // é›·è¾¾å›¾
    renderPriceRangeECharts(...);  // ä»·æ ¼åŒºé—´åˆ†å¸ƒ
    renderAreaDistributionECharts(...); // é¢ç§¯åˆ†å¸ƒ
    
    // 4. æ¸²æŸ“ä¸“ä¸šå›¾è¡¨
    renderPriceViolin(...);        // å°æç´å›¾
    renderDistrictHeatmapFull(...); // çƒ­åŠ›å›¾
    renderPriceWaterfall(...);     // ç€‘å¸ƒå›¾
    
    // 5. æ¸²æŸ“æˆ·å‹åˆ†æï¼ˆå¦‚æœæœ‰æ•°æ®ï¼‰
    if (analysisData.house_type_analysis?.available) {
        renderHouseTypeAnalysis();
    }
}
```

### 3. å›¾è¡¨æ¸²æŸ“å±‚

**æ–‡ä»¶**: `static/js/echarts_renderer.js`

ä½¿ç”¨ **ECharts** åº“è¿›è¡Œä¸“ä¸šçš„æ•°æ®å¯è§†åŒ–ï¼š

#### 3.1 ä»·æ ¼è¶‹åŠ¿å›¾
```javascript
function renderPriceTrendECharts(data, containerId) {
    const chart = echarts.init(document.getElementById(containerId));
    
    const option = {
        xAxis: { type: 'category', data: months },
        yAxis: { type: 'value', name: 'æˆäº¤ä»·ï¼ˆä¸‡å…ƒï¼‰' },
        series: [{
            type: 'line',
            data: prices,
            smooth: true,
            areaStyle: { /* æ¸å˜å¡«å…… */ }
        }]
    };
    
    chart.setOption(option);
}
```

**ç‰¹ç‚¹**:
- å¹³æ»‘æ›²çº¿ + é¢ç§¯å¡«å……
- æ”¯æŒç¼©æ”¾å’Œæ‹–æ‹½
- æ ‡è®°æœ€é«˜/æœ€ä½ç‚¹
- æ˜¾ç¤ºå¹³å‡å€¼çº¿

#### 3.2 ç®±çº¿å›¾
```javascript
function renderPriceBoxPlot(basicStats, containerId) {
    const chart = echarts.init(document.getElementById(containerId));
    
    // ä½¿ç”¨å››åˆ†ä½æ•°æ•°æ®
    const boxplotData = [[
        price.min,    // æœ€å°å€¼
        price.q25,    // Q1
        price.median, // ä¸­ä½æ•°
        price.q75,    // Q3
        price.max     // æœ€å¤§å€¼
    ]];
    
    const option = {
        series: [{
            type: 'boxplot',
            data: boxplotData
        }]
    };
    
    chart.setOption(option);
}
```

#### 3.3 é›·è¾¾å›¾
```javascript
function renderInvestmentRadar(investmentData, volatilityData, containerId) {
    const option = {
        radar: {
            indicator: [
                { name: 'ä»·æ ¼è¶‹åŠ¿', max: 100 },
                { name: 'æˆäº¤é‡è¶‹åŠ¿', max: 100 },
                { name: 'å¸‚åœºç¨³å®šæ€§', max: 100 },
                { name: 'æŠ•èµ„æŒ‡æ•°', max: 100 },
                { name: 'å¸‚åœºæ´»è·ƒåº¦', max: 100 }
            ]
        },
        series: [{
            type: 'radar',
            data: [{
                value: [ä»·æ ¼è¶‹åŠ¿åˆ†æ•°, æˆäº¤é‡è¶‹åŠ¿åˆ†æ•°, ...]
            }]
        }]
    };
}
```

#### 3.4 çƒ­åŠ›å›¾
```javascript
function renderDistrictHeatmapFull(heatmapData, containerId) {
    // è½¬æ¢æ•°æ®æ ¼å¼ä¸º [x, y, value]
    const seriesData = [];
    for (let i = 0; i < districts.length; i++) {
        for (let j = 0; j < months.length; j++) {
            seriesData.push([j, i, heatmapData.data[i][j]]);
        }
    }
    
    const option = {
        xAxis: { type: 'category', data: months },
        yAxis: { type: 'category', data: districts },
        visualMap: { /* é¢œè‰²æ˜ å°„ */ },
        series: [{
            type: 'heatmap',
            data: seriesData
        }]
    };
}
```

### 4. HTML æ¨¡æ¿å±‚

**æ–‡ä»¶**: `templates/analysis.html`

#### 4.1 é¡µé¢ç»“æ„
```html
<div id="loading-analysis">
    <!-- åŠ è½½åŠ¨ç”» -->
</div>

<div id="analysis-content" style="display: none;">
    <!-- AIæ™ºèƒ½æ¦‚è§ˆ -->
    <div id="city-ai-overview-content"></div>
    
    <!-- æŠ•èµ„æŒ‡æ•°å¡ç‰‡ -->
    <div id="investment-score"></div>
    
    <!-- åŸºç¡€ç»Ÿè®¡ -->
    <div id="basic-stats"></div>
    
    <!-- å„ç§å›¾è¡¨å®¹å™¨ -->
    <div id="trend-chart" style="height: 450px;"></div>
    <div id="price-boxplot" style="height: 350px;"></div>
    <div id="investment-radar" style="height: 400px;"></div>
    <!-- ... æ›´å¤šå›¾è¡¨å®¹å™¨ ... -->
</div>
```

#### 4.2 åŠ¨æ€å†…å®¹æ³¨å…¥

**ç»Ÿè®¡å¡ç‰‡ç¤ºä¾‹**:
```javascript
function renderBasicStats() {
    const container = document.getElementById('basic-stats');
    
    container.innerHTML = stats.map(stat => `
        <div class="stat-box">
            <div class="stat-label">${stat.label}</div>
            <div class="stat-value">${stat.value}<span class="stat-unit">${stat.unit}</span></div>
        </div>
    `).join('');
}
```

**è¡¨æ ¼ç¤ºä¾‹**:
```javascript
function renderDistrictAnalysis() {
    const table = document.getElementById('district-table');
    
    table.innerHTML = `
        <thead>...</thead>
        <tbody>
            ${data.map(district => `
                <tr>
                    <td>${district.district}</td>
                    <td>${district.avg_price} ä¸‡å…ƒ</td>
                    <!-- ... -->
                </tr>
            `).join('')}
        </tbody>
    `;
}
```

### 5. AI åˆ†æå±•ç¤º

**æ–‡ä»¶**: `templates/analysis.html` (ç¬¬ 589-631 è¡Œ)

ä½¿ç”¨ **Server-Sent Events (SSE)** è¿›è¡Œæµå¼å±•ç¤ºï¼š

```javascript
async function loadCityAIOverview() {
    const contentDiv = document.getElementById('city-ai-overview-content');
    
    // åˆ›å»º SSE è¿æ¥
    const eventSource = new EventSource(
        `/api/city/${cityNameEn}/ai-overview-stream?role=${role}`
    );
    
    let fullText = '';
    
    // æ¥æ”¶æµå¼æ•°æ®
    eventSource.onmessage = function(event) {
        if (event.data === '[DONE]') {
            eventSource.close();
            return;
        }
        
        const data = JSON.parse(event.data);
        if (data.content) {
            fullText += data.content;
            // å®æ—¶æ¸²æŸ“ Markdown
            contentDiv.innerHTML = renderMarkdown(fullText);
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            contentDiv.scrollTop = contentDiv.scrollHeight;
        }
    };
}
```

**Markdown æ¸²æŸ“**:
```javascript
function renderMarkdown(text) {
    // 1. å¤„ç†æ ‡é¢˜
    html = html.replace(/^### (.+)$/gm, '<h4>$1</h4>');
    
    // 2. å¤„ç†åŠ ç²—
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    
    // 3. å¤„ç†åˆ—è¡¨
    html = html.replace(/^(\d+)\.\s+(.+)$/gm, '<div>$1. $2</div>');
    
    // 4. å¤„ç†æ®µè½
    // ...
    
    return html;
}
```

## ğŸ¨ æ ·å¼ç³»ç»Ÿ

### CSS æ–‡ä»¶ç»“æ„

1. **`static/css/analysis.css`** - ä¸»æ ·å¼æ–‡ä»¶
   - ç»Ÿè®¡å¡ç‰‡æ ·å¼
   - å›¾è¡¨å®¹å™¨æ ·å¼
   - å“åº”å¼å¸ƒå±€

2. **`static/css/role_selector.css`** - è§’è‰²é€‰æ‹©å™¨æ ·å¼

3. **`static/css/chart_explainer.css`** - å›¾è¡¨è¯´æ˜æ ·å¼

### å…³é”®æ ·å¼ç±»

```css
.stat-box {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px;
    border-radius: 12px;
}

.chart-container {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.analysis-section {
    margin-bottom: 30px;
    padding: 25px;
    background: white;
    border-radius: 15px;
}
```

## ğŸ”§ äº¤äº’åŠŸèƒ½

### 1. è§’è‰²è¿‡æ»¤

**æ–‡ä»¶**: `templates/analysis.html` (ç¬¬ 529-555 è¡Œ)

```javascript
async function applyRoleFilter() {
    const role = await ensureRoleLoaded();
    
    // æ ¹æ®è§’è‰²éšè—/æ˜¾ç¤ºå†…å®¹
    const hideElements = document.querySelectorAll('.role-filter');
    hideElements.forEach(el => {
        const hideFor = el.getAttribute('data-hide-for');
        if (hideFor && hideFor.includes(role)) {
            el.style.display = 'none';
        } else {
            el.style.display = 'block';
        }
    });
}
```

### 2. AI å›¾è¡¨åˆ†æ

**æ–‡ä»¶**: `static/js/chart_ai.js`

```javascript
async function analyzeChart(chartType, chartId, chartTitle) {
    // 1. è·å–å›¾è¡¨æ•°æ®
    const chartData = getChartData(chartType);
    
    // 2. å‘é€åˆ° AI API
    const response = await fetch('/api/chart/analyze', {
        method: 'POST',
        body: JSON.stringify({
            chart_type: chartType,
            data: chartData
        })
    });
    
    // 3. æ˜¾ç¤º AI åˆ†æç»“æœ
    const result = await response.json();
    document.getElementById(chartId).innerHTML = renderMarkdown(result.analysis);
}
```

### 3. å›¾è¡¨è¯´æ˜

**æ–‡ä»¶**: `static/js/chart_explainer.js`

ç‚¹å‡»"â“ è®¡ç®—æ–¹æ³•"æŒ‰é’®æ—¶ï¼Œæ˜¾ç¤ºå›¾è¡¨è®¡ç®—æ–¹æ³•çš„è¯¦ç»†è¯´æ˜ã€‚

## ğŸ“Š æ•°æ®æ ¼å¼

### åç«¯è¿”å›çš„æ•°æ®ç»“æ„

```json
{
    "success": true,
    "analysis": {
        "investment_index": {
            "index_score": 75.5,
            "price_trend_score": 12.3,
            "volume_trend_score": -5.2,
            "stability_score": 82.1,
            "recommendation": "å»ºè®®å…³æ³¨..."
        },
        "basic_stats": {
            "total_transactions": 12345,
            "price": {
                "mean": 350.5,
                "median": 320.0,
                "min": 150.0,
                "max": 800.0,
                "q25": 280.0,
                "q75": 420.0
            }
        },
        "price_trend": {
            "monthly_data": [
                {"å¹´æœˆ": "2023-01", "æˆäº¤ä»·ï¼ˆä¸‡å…ƒï¼‰": 320.5, "ç¯æ¯”": 2.3}
            ],
            "overall_trend": {
                "total_change_percent": 15.5,
                "trend_direction": "ä¸Šæ¶¨"
            }
        },
        // ... æ›´å¤šæ•°æ®
    }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

1. **æ‡’åŠ è½½**: å›¾è¡¨åªåœ¨æ•°æ®åŠ è½½å®Œæˆåæ‰åˆå§‹åŒ–
2. **å“åº”å¼**: ä½¿ç”¨ `window.addEventListener('resize')` è‡ªåŠ¨è°ƒæ•´å›¾è¡¨å¤§å°
3. **é”™è¯¯å¤„ç†**: æ¯ä¸ªæ¸²æŸ“å‡½æ•°éƒ½æœ‰æ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†
4. **è¶…æ—¶ä¿æŠ¤**: API è¯·æ±‚æœ‰ 30 ç§’è¶…æ—¶é™åˆ¶

## ğŸ“ æ€»ç»“

å±•ç¤ºç³»ç»Ÿçš„æ ¸å¿ƒæµç¨‹ï¼š

1. **æ•°æ®è·å–** â†’ `fetch` API ä»åç«¯è·å– JSON æ•°æ®
2. **æ•°æ®å­˜å‚¨** â†’ ä¿å­˜åˆ° `analysisData` å…¨å±€å˜é‡
3. **æ•°æ®æ¸²æŸ“** â†’ `renderAnalysis()` è°ƒåº¦å„ä¸ªæ¸²æŸ“å‡½æ•°
4. **å›¾è¡¨ç”Ÿæˆ** â†’ ECharts åº“åˆ›å»ºäº¤äº’å¼å›¾è¡¨
5. **å†…å®¹æ³¨å…¥** â†’ ç›´æ¥æ“ä½œ DOM æ’å…¥ HTML å†…å®¹
6. **AI å±•ç¤º** â†’ SSE æµå¼ä¼ è¾“ï¼Œå®æ—¶æ¸²æŸ“ Markdown

æ•´ä¸ªç³»ç»Ÿé‡‡ç”¨**æ¨¡å—åŒ–è®¾è®¡**ï¼Œæ¯ä¸ªåŠŸèƒ½éƒ½æœ‰ç‹¬ç«‹çš„æ¸²æŸ“å‡½æ•°ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•ã€‚

