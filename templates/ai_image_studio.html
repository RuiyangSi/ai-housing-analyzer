{% extends "base_layout.html" %}

{% block title %}AI åˆ›æ„å›¾åƒå·¥ä½œå®¤{% endblock %}

{% block extra_styles %}
<style>
    .studio-container {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 30px;
        min-height: calc(100vh - 100px);
        padding: 20px 0;
    }
    
    /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
    .control-panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.15);
        height: fit-content;
        position: sticky;
        top: 20px;
    }
    
    .panel-title {
        font-size: 1.4em;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .panel-title::before {
        content: 'ğŸ¨';
        font-size: 1.2em;
    }
    
    /* åœºæ™¯é€‰æ‹© */
    .scene-section {
        margin-bottom: 25px;
    }
    
    .section-label {
        font-size: 0.85em;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .scene-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .scene-card {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: 2px solid transparent;
        border-radius: 12px;
        padding: 15px 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }
    
    .scene-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
    }
    
    .scene-card.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: transparent;
    }
    
    .scene-card.active .scene-icon,
    .scene-card.active .scene-name {
        color: white;
    }
    
    .scene-icon {
        font-size: 1.8em;
        margin-bottom: 5px;
    }
    
    .scene-name {
        font-size: 0.85em;
        font-weight: 600;
        color: #475569;
    }
    
    /* å…³é”®è¯æ ‡ç­¾ */
    .tags-section {
        margin-bottom: 25px;
    }
    
    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .tag {
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        border-radius: 20px;
        padding: 6px 14px;
        font-size: 0.85em;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .tag:hover {
        background: #e0e7ff;
        border-color: #c7d2fe;
        color: #4f46e5;
    }
    
    .tag.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: transparent;
        color: white;
    }
    
    /* è‡ªå®šä¹‰è¾“å…¥ */
    .custom-input-section {
        margin-bottom: 25px;
    }
    
    .custom-textarea {
        width: 100%;
        min-height: 100px;
        padding: 15px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 0.95em;
        resize: vertical;
        transition: all 0.3s ease;
        font-family: inherit;
    }
    
    .custom-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .custom-textarea::placeholder {
        color: #94a3b8;
    }
    
    /* é£æ ¼é€‰æ‹© */
    .style-options {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .style-btn {
        padding: 8px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 25px;
        background: white;
        font-size: 0.85em;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #64748b;
    }
    
    .style-btn:hover {
        border-color: #667eea;
        color: #667eea;
    }
    
    .style-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: transparent;
        color: white;
    }
    
    /* ç”ŸæˆæŒ‰é’® */
    .generate-btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    
    .generate-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }
    
    .generate-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .generate-btn .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* å³ä¾§å±•ç¤ºåŒº */
    .gallery-panel {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.1);
    }
    
    .gallery-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .gallery-title {
        font-size: 1.2em;
        font-weight: 600;
        color: #1e293b;
    }
    
    .gallery-count {
        font-size: 0.85em;
        color: #64748b;
        background: #f1f5f9;
        padding: 5px 12px;
        border-radius: 20px;
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
        text-align: center;
        padding: 80px 40px;
        color: #94a3b8;
    }
    
    .empty-icon {
        font-size: 4em;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    .empty-text {
        font-size: 1.1em;
        margin-bottom: 10px;
    }
    
    .empty-hint {
        font-size: 0.9em;
        color: #cbd5e1;
    }
    
    /* å›¾ç‰‡ç½‘æ ¼ */
    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }
    
    .image-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }
    
    .image-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.2);
    }
    
    .image-wrapper {
        position: relative;
        padding-top: 100%;
        background: #f8fafc;
        overflow: hidden;
    }
    
    .image-wrapper img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }
    
    .image-card:hover .image-wrapper img {
        transform: scale(1.05);
    }
    
    .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.7));
        opacity: 0;
        transition: opacity 0.3s ease;
        display: flex;
        align-items: flex-end;
        padding: 15px;
    }
    
    .image-card:hover .image-overlay {
        opacity: 1;
    }
    
    .image-actions {
        display: flex;
        gap: 8px;
    }
    
    .action-btn {
        padding: 8px 14px;
        background: rgba(255,255,255,0.95);
        border: none;
        border-radius: 20px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #475569;
    }
    
    .action-btn:hover {
        background: white;
        color: #667eea;
    }
    
    .image-info {
        padding: 15px;
    }
    
    .image-prompt {
        font-size: 0.85em;
        color: #64748b;
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .image-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        font-size: 0.75em;
        color: #94a3b8;
    }
    
    /* åŠ è½½çŠ¶æ€å¡ç‰‡ */
    .loading-card {
        background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
        border-radius: 16px;
        overflow: hidden;
        animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .loading-wrapper {
        padding-top: 100%;
        position: relative;
    }
    
    .loading-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #667eea;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(102, 126, 234, 0.2);
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    /* é¢„è§ˆæ¨¡æ€æ¡† */
    .preview-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 40px;
    }
    
    .preview-modal.active {
        display: flex;
    }
    
    .preview-content {
        max-width: 90vw;
        max-height: 90vh;
        position: relative;
    }
    
    .preview-content img {
        max-width: 100%;
        max-height: 85vh;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    
    .preview-close {
        position: absolute;
        top: -50px;
        right: 0;
        background: rgba(255,255,255,0.1);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.5em;
        transition: all 0.2s ease;
    }
    
    .preview-close:hover {
        background: rgba(255,255,255,0.2);
    }
    
    /* å“åº”å¼ */
    @media (max-width: 900px) {
        .studio-container {
            grid-template-columns: 1fr;
        }
        
        .control-panel {
            position: static;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="studio-container">
    <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <h2 class="panel-title">AI åˆ›æ„å·¥ä½œå®¤</h2>
        
        <!-- åœºæ™¯é€‰æ‹© -->
        <div class="scene-section">
            <div class="section-label">é€‰æ‹©åœºæ™¯ç±»å‹</div>
            <div class="scene-grid">
                <div class="scene-card active" data-scene="dream_home">
                    <div class="scene-icon">ğŸ </div>
                    <div class="scene-name">æ¢¦æƒ³ä¹‹å®¶</div>
                </div>
                <div class="scene-card" data-scene="lifestyle">
                    <div class="scene-icon">ğŸŒŸ</div>
                    <div class="scene-name">ç”Ÿæ´»åœºæ™¯</div>
                </div>
                <div class="scene-card" data-scene="renovation">
                    <div class="scene-icon">ğŸ”¨</div>
                    <div class="scene-name">è£…ä¿®æ•ˆæœ</div>
                </div>
                <div class="scene-card" data-scene="neighborhood">
                    <div class="scene-icon">ğŸ˜ï¸</div>
                    <div class="scene-name">ç¤¾åŒºæ„¿æ™¯</div>
                </div>
                <div class="scene-card" data-scene="seasonal">
                    <div class="scene-icon">ğŸ‚</div>
                    <div class="scene-name">å››å­£æ°›å›´</div>
                </div>
                <div class="scene-card" data-scene="investment">
                    <div class="scene-icon">ğŸ“ˆ</div>
                    <div class="scene-name">æŠ•èµ„æ•…äº‹</div>
                </div>
            </div>
        </div>
        
        <!-- å…³é”®è¯æ ‡ç­¾ -->
        <div class="tags-section">
            <div class="section-label">æ·»åŠ å…³é”®è¯ï¼ˆå¯å¤šé€‰ï¼‰</div>
            <div class="tags-container" id="tags-container">
                <!-- ä¼šæ ¹æ®åœºæ™¯åŠ¨æ€æ›´æ–° -->
            </div>
        </div>
        
        <!-- é£æ ¼é€‰æ‹© -->
        <div class="style-section" style="margin-bottom: 25px;">
            <div class="section-label">é€‰æ‹©é£æ ¼</div>
            <div class="style-options">
                <button class="style-btn active" data-style="modern">ç°ä»£ç®€çº¦</button>
                <button class="style-btn" data-style="chinese">ä¸­å¼é›…è‡´</button>
                <button class="style-btn" data-style="european">æ¬§å¼å¥¢å</button>
                <button class="style-btn" data-style="japanese">æ—¥å¼ç¦…æ„</button>
                <button class="style-btn" data-style="industrial">å·¥ä¸šé£æ ¼</button>
            </div>
        </div>
        
        <!-- è‡ªå®šä¹‰è¾“å…¥ -->
        <div class="custom-input-section">
            <div class="section-label">è‡ªå®šä¹‰æè¿°ï¼ˆå¯é€‰ï¼‰</div>
            <textarea class="custom-textarea" id="custom-prompt" 
                placeholder="æ·»åŠ æ‚¨çš„ä¸ªæ€§åŒ–æè¿°ï¼Œä¾‹å¦‚ï¼š&#10;â€¢ æ¸©é¦¨çš„ä¸‰å£ä¹‹å®¶&#10;â€¢ è½åœ°çª—çœ‹åŸå¸‚å¤œæ™¯&#10;â€¢ æœ‰ä¸€åªçŒ«å’ªåœ¨æ²™å‘ä¸Š"></textarea>
        </div>
        
        <!-- åŸå¸‚é€‰æ‹© -->
        <div class="city-section" style="margin-bottom: 25px;">
            <div class="section-label">é€‰æ‹©åŸå¸‚</div>
            <select id="city-select" style="width: 100%; padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 0.95em; cursor: pointer;">
                <option value="åŒ—äº¬">åŒ—äº¬</option>
                <option value="ä¸Šæµ·">ä¸Šæµ·</option>
                <option value="å¹¿å·">å¹¿å·</option>
                <option value="æ·±åœ³">æ·±åœ³</option>
                <option value="æ­å·">æ­å·</option>
                <option value="æˆéƒ½">æˆéƒ½</option>
                <option value="å—äº¬">å—äº¬</option>
                <option value="è‹å·">è‹å·</option>
            </select>
        </div>
        
        <!-- ç”ŸæˆæŒ‰é’® -->
        <button class="generate-btn" id="generate-btn" onclick="generateImage()">
            <span>âœ¨ ç”Ÿæˆåˆ›æ„å›¾åƒ</span>
        </button>
        
        <p style="text-align: center; margin-top: 15px; font-size: 0.8em; color: #94a3b8;">
            é¢„è®¡ç”Ÿæˆæ—¶é—´ï¼š10-20ç§’
        </p>
    </div>
    
    <!-- å³ä¾§å±•ç¤ºåŒº -->
    <div class="gallery-panel">
        <div class="gallery-header">
            <h3 class="gallery-title">ğŸ–¼ï¸ æˆ‘çš„åˆ›æ„å›¾åº“</h3>
            <span class="gallery-count" id="gallery-count">0 å¼ å›¾ç‰‡</span>
        </div>
        
        <div id="gallery-content">
            <!-- ç©ºçŠ¶æ€ -->
            <div class="empty-state" id="empty-state">
                <div class="empty-icon">ğŸ¨</div>
                <div class="empty-text">è¿˜æ²¡æœ‰ç”Ÿæˆä»»ä½•å›¾ç‰‡</div>
                <div class="empty-hint">é€‰æ‹©åœºæ™¯å’Œå…³é”®è¯ï¼Œå¼€å§‹åˆ›ä½œæ‚¨çš„ä¸“å±å›¾åƒ</div>
            </div>
            
            <!-- å›¾ç‰‡ç½‘æ ¼ -->
            <div class="image-grid" id="image-grid" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
<div class="preview-modal" id="preview-modal" onclick="closePreview(event)">
    <div class="preview-content">
        <button class="preview-close" onclick="closePreview()">&times;</button>
        <img id="preview-image" src="" alt="é¢„è§ˆå›¾ç‰‡">
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // åœºæ™¯å¯¹åº”çš„å…³é”®è¯
    const sceneTags = {
        dream_home: [
            'è½åœ°çª—', 'åŸå¸‚æ™¯è§‚', 'å¼€æ”¾å¨æˆ¿', 'ä¹¦æˆ¿è§’è½', 'é˜³å°èŠ±å›­',
            'å¤§å®¢å…', 'æ­¥å…¥å¼è¡£å¸½é—´', 'æ™ºèƒ½å®¶å±…', 'æ¸©é¦¨ç¯å…‰', 'æœ¨è´¨å…ƒç´ '
        ],
        lifestyle: [
            'å®¶åº­æ—©é¤', 'å‘¨æœ«ä¼‘é—²', 'å±…å®¶åŠå…¬', 'æœ‹å‹èšä¼š', 'é˜…è¯»æ—¶å…‰',
            'ä¸‹åˆèŒ¶', 'ç‘œä¼½ç©ºé—´', 'äº²å­æ—¶å…‰', 'å® ç‰©é™ªä¼´', 'æµªæ¼«æ™šé¤'
        ],
        renovation: [
            'å®¢å…', 'ä¸»å§', 'å¨æˆ¿', 'å«ç”Ÿé—´', 'ä¹¦æˆ¿',
            'å„¿ç«¥æˆ¿', 'é˜³å°', 'ç„å…³', 'é¤å…', 'è¡£å¸½é—´'
        ],
        neighborhood: [
            'ç»¿åŒ–å…¬å›­', 'å•†ä¸šä¸­å¿ƒ', 'ä¼˜è´¨å­¦æ ¡', 'åœ°é“ç«™', 'åŒ»é™¢',
            'å¥èº«è®¾æ–½', 'å„¿ç«¥ä¹å›­', 'å’–å•¡è¡—åŒº', 'è‰ºæœ¯ä¸­å¿ƒ', 'æ²³æ™¯æ¹–æ™¯'
        ],
        seasonal: [
            'æ˜¥æ—¥é˜³å…‰', 'å¤æ—¥æ¸…å‡‰', 'ç§‹æ—¥æ¸©é¦¨', 'å†¬æ—¥æš–æ„',
            'æ¸…æ™¨æ—¶åˆ†', 'åˆåé˜³å…‰', 'é»„æ˜ä½™æ™–', 'å¤œæ™šç¯ç«'
        ],
        investment: [
            'ç§Ÿé‡‘æ”¶å…¥', 'æˆ¿äº§å¢å€¼', 'è´¢åŠ¡è‡ªç”±', 'è¢«åŠ¨æ”¶å…¥',
            'æˆåŠŸæŠ•èµ„', 'èµ„äº§é…ç½®', 'å®¶æ—ä¼ æ‰¿', 'ç¨³å¥å›æŠ¥'
        ]
    };
    
    let currentScene = 'dream_home';
    let currentStyle = 'modern';
    let selectedTags = new Set();
    let generatedImages = [];
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        updateTags();
        bindEvents();
    });
    
    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // åœºæ™¯é€‰æ‹©
        document.querySelectorAll('.scene-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.scene-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                currentScene = this.dataset.scene;
                selectedTags.clear();
                updateTags();
            });
        });
        
        // é£æ ¼é€‰æ‹©
        document.querySelectorAll('.style-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentStyle = this.dataset.style;
            });
        });
    }
    
    // æ›´æ–°å…³é”®è¯æ ‡ç­¾
    function updateTags() {
        const container = document.getElementById('tags-container');
        const tags = sceneTags[currentScene] || [];
        
        container.innerHTML = tags.map(tag => 
            `<span class="tag" onclick="toggleTag(this, '${tag}')">${tag}</span>`
        ).join('');
    }
    
    // åˆ‡æ¢æ ‡ç­¾é€‰æ‹©
    function toggleTag(element, tag) {
        element.classList.toggle('selected');
        if (selectedTags.has(tag)) {
            selectedTags.delete(tag);
        } else {
            selectedTags.add(tag);
        }
    }
    
    // ç”Ÿæˆå›¾åƒ
    async function generateImage() {
        const btn = document.getElementById('generate-btn');
        const customPrompt = document.getElementById('custom-prompt').value.trim();
        const city = document.getElementById('city-select').value;
        
        // ç¦ç”¨æŒ‰é’®
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div><span>æ­£åœ¨ç”Ÿæˆ...</span>';
        
        // æ˜¾ç¤ºåŠ è½½å¡ç‰‡
        showLoadingCard();
        
        // æ„å»ºè¯·æ±‚æ•°æ®
        const requestData = {
            type: currentScene,
            city: city,
            style: currentStyle,
            tags: Array.from(selectedTags),
            custom_prompt: customPrompt
        };
        
        // æ ¹æ®åœºæ™¯è®¾ç½®é¢å¤–å‚æ•°
        if (currentScene === 'lifestyle') {
            const lifestyleMap = {
                'å®¶åº­æ—©é¤': 'family_morning',
                'å‘¨æœ«ä¼‘é—²': 'weekend_relax',
                'å±…å®¶åŠå…¬': 'home_office',
                'æœ‹å‹èšä¼š': 'rooftop_party'
            };
            for (const tag of selectedTags) {
                if (lifestyleMap[tag]) {
                    requestData.lifestyle = lifestyleMap[tag];
                    break;
                }
            }
        }
        
        if (currentScene === 'renovation') {
            const roomMap = {
                'å®¢å…': 'living_room',
                'ä¸»å§': 'bedroom',
                'å¨æˆ¿': 'kitchen',
                'å«ç”Ÿé—´': 'bathroom'
            };
            for (const tag of selectedTags) {
                if (roomMap[tag]) {
                    requestData.room = roomMap[tag];
                    break;
                }
            }
        }
        
        if (currentScene === 'seasonal') {
            const seasonMap = {
                'æ˜¥æ—¥é˜³å…‰': 'spring',
                'å¤æ—¥æ¸…å‡‰': 'summer',
                'ç§‹æ—¥æ¸©é¦¨': 'autumn',
                'å†¬æ—¥æš–æ„': 'winter'
            };
            for (const tag of selectedTags) {
                if (seasonMap[tag]) {
                    requestData.season = seasonMap[tag];
                    break;
                }
            }
        }
        
        try {
            const response = await fetch('/api/ai/generate-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });
            
            const result = await response.json();
            
            removeLoadingCard();
            
            if (result.success && result.image_url) {
                addImageToGallery({
                    url: result.image_url,
                    scene: currentScene,
                    style: currentStyle,
                    tags: Array.from(selectedTags),
                    customPrompt: customPrompt,
                    city: city,
                    timestamp: new Date().toLocaleString()
                });
            } else {
                alert('å›¾åƒç”Ÿæˆå¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            removeLoadingCard();
            alert('è¯·æ±‚å¤±è´¥ï¼š' + error.message);
        }
        
        // æ¢å¤æŒ‰é’®
        btn.disabled = false;
        btn.innerHTML = '<span>âœ¨ ç”Ÿæˆåˆ›æ„å›¾åƒ</span>';
    }
    
    // æ˜¾ç¤ºåŠ è½½å¡ç‰‡
    function showLoadingCard() {
        const grid = document.getElementById('image-grid');
        const emptyState = document.getElementById('empty-state');
        
        emptyState.style.display = 'none';
        grid.style.display = 'grid';
        
        const loadingCard = document.createElement('div');
        loadingCard.id = 'loading-card';
        loadingCard.className = 'loading-card';
        loadingCard.innerHTML = `
            <div class="loading-wrapper">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <div style="font-weight: 600;">AI æ­£åœ¨åˆ›ä½œ...</div>
                    <div style="font-size: 0.85em; margin-top: 5px; opacity: 0.7;">é¢„è®¡ 10-20 ç§’</div>
                </div>
            </div>
        `;
        
        grid.insertBefore(loadingCard, grid.firstChild);
    }
    
    // ç§»é™¤åŠ è½½å¡ç‰‡
    function removeLoadingCard() {
        const loadingCard = document.getElementById('loading-card');
        if (loadingCard) {
            loadingCard.remove();
        }
    }
    
    // æ·»åŠ å›¾ç‰‡åˆ°å›¾åº“
    function addImageToGallery(imageData) {
        generatedImages.unshift(imageData);
        updateGalleryCount();
        
        const grid = document.getElementById('image-grid');
        const emptyState = document.getElementById('empty-state');
        
        emptyState.style.display = 'none';
        grid.style.display = 'grid';
        
        const sceneNames = {
            dream_home: 'ğŸ  æ¢¦æƒ³ä¹‹å®¶',
            lifestyle: 'ğŸŒŸ ç”Ÿæ´»åœºæ™¯',
            renovation: 'ğŸ”¨ è£…ä¿®æ•ˆæœ',
            neighborhood: 'ğŸ˜ï¸ ç¤¾åŒºæ„¿æ™¯',
            seasonal: 'ğŸ‚ å››å­£æ°›å›´',
            investment: 'ğŸ“ˆ æŠ•èµ„æ•…äº‹'
        };
        
        const styleNames = {
            modern: 'ç°ä»£ç®€çº¦',
            chinese: 'ä¸­å¼é›…è‡´',
            european: 'æ¬§å¼å¥¢å',
            japanese: 'æ—¥å¼ç¦…æ„',
            industrial: 'å·¥ä¸šé£æ ¼'
        };
        
        const card = document.createElement('div');
        card.className = 'image-card';
        card.innerHTML = `
            <div class="image-wrapper">
                <img src="${imageData.url}" alt="AIç”Ÿæˆå›¾åƒ" onclick="previewImage('${imageData.url}')">
                <div class="image-overlay">
                    <div class="image-actions">
                        <button class="action-btn" onclick="previewImage('${imageData.url}')">ğŸ” æŸ¥çœ‹</button>
                        <button class="action-btn" onclick="downloadImage('${imageData.url}')">ğŸ’¾ ä¸‹è½½</button>
                    </div>
                </div>
            </div>
            <div class="image-info">
                <div class="image-prompt">
                    ${sceneNames[imageData.scene] || imageData.scene} Â· ${styleNames[imageData.style] || imageData.style}
                    ${imageData.tags.length > 0 ? ' Â· ' + imageData.tags.slice(0, 3).join('ã€') : ''}
                    ${imageData.customPrompt ? ' Â· ' + imageData.customPrompt.substring(0, 30) : ''}
                </div>
                <div class="image-meta">
                    <span>ğŸ“ ${imageData.city}</span>
                    <span>${imageData.timestamp}</span>
                </div>
            </div>
        `;
        
        grid.insertBefore(card, grid.firstChild);
    }
    
    // æ›´æ–°å›¾åº“è®¡æ•°
    function updateGalleryCount() {
        document.getElementById('gallery-count').textContent = generatedImages.length + ' å¼ å›¾ç‰‡';
    }
    
    // é¢„è§ˆå›¾ç‰‡
    function previewImage(url) {
        document.getElementById('preview-image').src = url;
        document.getElementById('preview-modal').classList.add('active');
    }
    
    // å…³é—­é¢„è§ˆ
    function closePreview(event) {
        if (!event || event.target.id === 'preview-modal' || event.target.classList.contains('preview-close')) {
            document.getElementById('preview-modal').classList.remove('active');
        }
    }
    
    // ä¸‹è½½å›¾ç‰‡
    async function downloadImage(url) {
        try {
            const response = await fetch(url);
            const blob = await response.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = 'ai-image-' + Date.now() + '.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(downloadUrl);
        } catch (error) {
            // å¦‚æœ CORS é˜»æ­¢ï¼Œç›´æ¥æ‰“å¼€æ–°çª—å£
            window.open(url, '_blank');
        }
    }
    
    // ESC å…³é—­é¢„è§ˆ
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePreview();
        }
    });
</script>
{% endblock %}

