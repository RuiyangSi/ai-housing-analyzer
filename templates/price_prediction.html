{% extends "base_layout.html" %}

{% block title %}AI æˆ¿ä»·é¢„æµ‹{% endblock %}

{% block extra_styles %}
<style>
    .prediction-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 30px;
        color: white;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }
    
    .page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
    }
    
    .page-header h1 {
        font-size: 2em;
        margin: 0 0 10px 0;
        position: relative;
        z-index: 1;
    }
    
    .page-header p {
        opacity: 0.9;
        margin: 0;
        position: relative;
        z-index: 1;
    }
    
    /* æ§åˆ¶é¢æ¿ */
    .control-section {
        background: white;
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .control-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .control-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .control-label {
        font-size: 0.85em;
        font-weight: 600;
        color: #64748b;
    }
    
    .control-select, .control-input {
        padding: 12px 15px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 1em;
        transition: all 0.3s ease;
        background: white;
    }
    
    .control-select:focus, .control-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .predict-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 14px 30px;
        border-radius: 12px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    
    .predict-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .predict-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .predict-btn .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* é¢„æµ‹ç»“æœåŒºåŸŸ */
    .results-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
    }
    
    @media (max-width: 900px) {
        .results-section {
            grid-template-columns: 1fr;
        }
    }
    
    /* ç»Ÿè®¡é¢„æµ‹å¡ç‰‡ */
    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .card-icon {
        font-size: 1.8em;
    }
    
    .card-title {
        font-size: 1.2em;
        font-weight: 600;
        color: #1e293b;
    }
    
    /* è¶‹åŠ¿æŒ‡ç¤ºå™¨ */
    .trend-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        margin-bottom: 20px;
    }
    
    .trend-value {
        font-size: 2.5em;
        font-weight: 700;
    }
    
    .trend-up { color: #ef4444; }
    .trend-down { color: #10b981; }
    .trend-stable { color: #f59e0b; }
    
    .trend-label {
        text-align: left;
    }
    
    .trend-label .direction {
        font-size: 1.2em;
        font-weight: 600;
        color: #1e293b;
    }
    
    .trend-label .desc {
        font-size: 0.9em;
        color: #64748b;
    }
    
    /* é¢„æµ‹å›¾è¡¨ */
    .prediction-chart {
        height: 300px;
        margin-top: 20px;
    }
    
    /* AI é¢„æµ‹å¡ç‰‡ */
    .ai-card {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        color: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    .ai-card .card-header {
        border-bottom-color: rgba(255,255,255,0.2);
    }
    
    .ai-card .card-title {
        color: white;
    }
    
    .ai-content {
        line-height: 1.8;
        font-size: 1em;
        min-height: 200px;
        max-height: 500px;
        overflow-y: auto;
    }
    
    .ai-content::-webkit-scrollbar {
        width: 6px;
    }
    
    .ai-content::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.3);
        border-radius: 3px;
    }
    
    .ai-loading {
        text-align: center;
        padding: 40px;
        color: rgba(255,255,255,0.7);
    }
    
    .ai-loading .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255,255,255,0.2);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    /* å¸‚åœºå› ç´ å¡ç‰‡ */
    .factors-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 20px;
    }
    
    .factor-item {
        background: #f8fafc;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }
    
    .factor-value {
        font-size: 1.5em;
        font-weight: 700;
        color: #667eea;
    }
    
    .factor-label {
        font-size: 0.8em;
        color: #64748b;
        margin-top: 5px;
    }
    
    /* åŒºåŸŸæ’å */
    .district-list {
        margin-top: 20px;
    }
    
    .district-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 15px;
        background: #f8fafc;
        border-radius: 8px;
        margin-bottom: 10px;
        transition: all 0.2s ease;
    }
    
    .district-item:hover {
        background: #e0e7ff;
    }
    
    .district-rank {
        width: 28px;
        height: 28px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85em;
        font-weight: 600;
    }
    
    .district-name {
        flex: 1;
        margin-left: 12px;
        font-weight: 500;
    }
    
    .district-price {
        font-weight: 600;
        color: #1e293b;
    }
    
    .district-change {
        font-size: 0.85em;
        margin-left: 10px;
        padding: 3px 8px;
        border-radius: 4px;
    }
    
    .district-change.up {
        background: #fee2e2;
        color: #dc2626;
    }
    
    .district-change.down {
        background: #d1fae5;
        color: #059669;
    }
    
    /* é¢„æµ‹æ—¶é—´çº¿ */
    .timeline-section {
        background: white;
        border-radius: 16px;
        padding: 25px;
        margin-top: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .timeline-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .timeline-item {
        background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
        padding: 20px 15px;
        border-radius: 12px;
        text-align: center;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .timeline-item:hover {
        border-color: #667eea;
        transform: translateY(-3px);
    }
    
    .timeline-month {
        font-size: 0.9em;
        color: #64748b;
        margin-bottom: 8px;
    }
    
    .timeline-price {
        font-size: 1.4em;
        font-weight: 700;
        color: #1e293b;
    }
    
    .timeline-range {
        font-size: 0.75em;
        color: #94a3b8;
        margin-top: 5px;
    }
    
    .timeline-confidence {
        margin-top: 10px;
        font-size: 0.8em;
    }
    
    .confidence-bar {
        height: 4px;
        background: #e2e8f0;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 5px;
    }
    
    .confidence-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 2px;
    }
    
    /* å…è´£å£°æ˜ */
    .disclaimer {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 15px 20px;
        margin-top: 25px;
        border-radius: 0 12px 12px 0;
        font-size: 0.9em;
        color: #92400e;
    }
</style>
{% endblock %}

{% block content %}
<div class="prediction-container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
        <h1>ğŸ”® AI æˆ¿ä»·é¢„æµ‹</h1>
        <p>åŸºäºå†å²æ•°æ® + AI æ·±åº¦åˆ†æï¼Œé¢„æµ‹æœªæ¥æˆ¿ä»·èµ°åŠ¿</p>
    </div>
    
    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-section">
        <div class="control-grid">
            <div class="control-item">
                <label class="control-label">é€‰æ‹©åŸå¸‚</label>
                <select id="city-select" class="control-select">
                    {% for city in cities %}
                    <option value="{{ city.name_en }}" {% if city.name_en == 'beijing' %}selected{% endif %}>
                        {{ city.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="control-item">
                <label class="control-label">é¢„æµ‹æ—¶é•¿</label>
                <select id="months-select" class="control-select">
                    <option value="3">3ä¸ªæœˆ</option>
                    <option value="6" selected>6ä¸ªæœˆ</option>
                    <option value="12">12ä¸ªæœˆ</option>
                </select>
            </div>
            <div class="control-item">
                <label class="control-label">ç›®æ ‡åŒºåŸŸï¼ˆå¯é€‰ï¼‰</label>
                <select id="district-select" class="control-select">
                    <option value="">å…¨å¸‚å¹³å‡</option>
                    <!-- åŠ¨æ€åŠ è½½ -->
                </select>
            </div>
            <div class="control-item" style="justify-content: flex-end;">
                <button id="predict-btn" class="predict-btn" onclick="startPrediction()">
                    <span>ğŸ”® å¼€å§‹é¢„æµ‹</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- ç»“æœåŒºåŸŸ -->
    <div id="results-area" style="display: none;">
        <!-- é¢„æµ‹å¯¹æ¯”å›¾è¡¨ï¼ˆå…¨å®½ï¼‰ -->
        <div class="stat-card" style="margin-bottom: 25px;">
            <div class="card-header">
                <span class="card-icon">ğŸ“ˆ</span>
                <span class="card-title">é¢„æµ‹å¯¹æ¯”å›¾è¡¨</span>
                <span style="margin-left: auto; font-size: 0.85em; color: #64748b;">
                    ğŸ”µ å†å²æ•°æ® &nbsp; ğŸŸ  ç»Ÿè®¡é¢„æµ‹ &nbsp; ğŸŸ¢ AIé¢„æµ‹
                </span>
            </div>
            <div id="prediction-chart" style="height: 400px;"></div>
        </div>
        
        <div class="results-section">
            <!-- ç»Ÿè®¡é¢„æµ‹ -->
            <div class="stat-card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“Š</span>
                    <span class="card-title">ç»Ÿè®¡æ¨¡å‹é¢„æµ‹</span>
                </div>
                
                <div class="trend-indicator">
                    <div id="trend-value" class="trend-value trend-stable">--</div>
                    <div class="trend-label">
                        <div id="trend-direction" class="direction">--</div>
                        <div id="trend-desc" class="desc">åŸºäºå†å²æ•°æ®è¶‹åŠ¿</div>
                    </div>
                </div>
                
                <div class="factors-grid">
                    <div class="factor-item">
                        <div id="factor-heat" class="factor-value">--</div>
                        <div class="factor-label">å¸‚åœºçƒ­åº¦</div>
                    </div>
                    <div class="factor-item">
                        <div id="factor-stability" class="factor-value">--</div>
                        <div class="factor-label">ä»·æ ¼ç¨³å®šæ€§</div>
                    </div>
                    <div class="factor-item">
                        <div id="factor-volume" class="factor-value">--</div>
                        <div class="factor-label">æˆäº¤é‡è¶‹åŠ¿</div>
                    </div>
                </div>
                
                <!-- AI é¢„æµ‹æ‘˜è¦ -->
                <div id="ai-summary" style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; color: white; display: none;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 1.5em;">ğŸ¤–</span>
                        <strong>AI é¢„æµ‹ç»“æœ</strong>
                    </div>
                    <div id="ai-summary-content"></div>
                </div>
            </div>
            
            <!-- AI é¢„æµ‹ -->
            <div class="ai-card">
                <div class="card-header">
                    <span class="card-icon">ğŸ¤–</span>
                    <span class="card-title">AI æ·±åº¦é¢„æµ‹åˆ†æ</span>
                </div>
                
                <div id="ai-content" class="ai-content">
                    <div class="ai-loading">
                        <div class="spinner"></div>
                        <p>AI æ­£åœ¨åˆ†ææ•°æ®å¹¶ç”Ÿæˆé¢„æµ‹...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åŒºåŸŸæ’å -->
        <div class="stat-card" style="margin-top: 25px;">
            <div class="card-header">
                <span class="card-icon">ğŸ†</span>
                <span class="card-title">åŒºåŸŸä»·æ ¼æ’å</span>
            </div>
            <div id="district-list" class="district-list">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
        
        <!-- é¢„æµ‹æ—¶é—´çº¿ -->
        <div class="timeline-section">
            <div class="card-header">
                <span class="card-icon">ğŸ“…</span>
                <span class="card-title">é€æœˆé¢„æµ‹è¯¦æƒ…</span>
            </div>
            <div id="timeline-grid" class="timeline-grid">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
        
        <!-- å…è´£å£°æ˜ -->
        <div class="disclaimer">
            âš ï¸ <strong>å…è´£å£°æ˜ï¼š</strong>ä»¥ä¸Šé¢„æµ‹ä»…åŸºäºå†å²æ•°æ®åˆ†æå’ŒAIæ¨¡å‹æ¨æ–­ï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚æˆ¿åœ°äº§å¸‚åœºå—å¤šç§å› ç´ å½±å“ï¼Œå®é™…ä»·æ ¼å¯èƒ½ä¸é¢„æµ‹å­˜åœ¨è¾ƒå¤§å·®å¼‚ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="{{ url_for('static', filename='js/user_role.js') }}"></script>
<script>
    let predictionChart = null;
    let currentData = null;
    
    // é¡µé¢åŠ è½½æ—¶è·å–åŒºåŸŸåˆ—è¡¨
    document.addEventListener('DOMContentLoaded', function() {
        loadDistricts();
        
        // åŸå¸‚å˜åŒ–æ—¶é‡æ–°åŠ è½½åŒºåŸŸ
        document.getElementById('city-select').addEventListener('change', loadDistricts);
    });
    
    // åŠ è½½åŒºåŸŸåˆ—è¡¨
    async function loadDistricts() {
        const city = document.getElementById('city-select').value;
        const districtSelect = document.getElementById('district-select');
        
        try {
            const response = await fetch(`/api/city/${city}/districts`);
            const result = await response.json();
            
            districtSelect.innerHTML = '<option value="">å…¨å¸‚å¹³å‡</option>';
            
            if (result.districts) {
                result.districts.forEach(d => {
                    districtSelect.innerHTML += `<option value="${d}">${d}</option>`;
                });
            }
        } catch (error) {
            console.error('åŠ è½½åŒºåŸŸå¤±è´¥:', error);
        }
    }
    
    // å­˜å‚¨ AI é¢„æµ‹æ•°æ®
    let aiPredictionData = null;
    
    // å¼€å§‹é¢„æµ‹
    async function startPrediction() {
        const btn = document.getElementById('predict-btn');
        const resultsArea = document.getElementById('results-area');
        
        const city = document.getElementById('city-select').value;
        const months = document.getElementById('months-select').value;
        const district = document.getElementById('district-select').value;
        
        // ç¦ç”¨æŒ‰é’®
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div><span>é¢„æµ‹ä¸­...</span>';
        
        // æ˜¾ç¤ºç»“æœåŒºåŸŸ
        resultsArea.style.display = 'block';
        
        // é‡ç½® AI å†…å®¹å’Œæ‘˜è¦
        document.getElementById('ai-content').innerHTML = `
            <div class="ai-loading">
                <div class="spinner"></div>
                <p>AI æ­£åœ¨åˆ†ææ•°æ®å¹¶ç”Ÿæˆé¢„æµ‹...</p>
            </div>
        `;
        document.getElementById('ai-summary').style.display = 'none';
        aiPredictionData = null;
        
        try {
            // 1. è·å–ç»Ÿè®¡é¢„æµ‹æ•°æ®
            const statsResponse = await fetch('/api/prediction/stats', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ city, months: parseInt(months), district })
            });
            
            const statsData = await statsResponse.json();
            
            if (statsData.success) {
                currentData = statsData;
                renderStatsPrediction(statsData);
            }
            
            // 2. è·å– AI é¢„æµ‹æ•°æ®ï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼ŒåŒæ—¶ç”¨äºå›¾è¡¨å’Œè¯¦ç»†åˆ†æï¼‰
            await fetchAIPredictionData(city, months, district);
            
        } catch (error) {
            console.error('é¢„æµ‹å¤±è´¥:', error);
            alert('é¢„æµ‹è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
        
        // æ¢å¤æŒ‰é’®
        btn.disabled = false;
        btn.innerHTML = '<span>ğŸ”® å¼€å§‹é¢„æµ‹</span>';
    }
    
    // è·å– AI é¢„æµ‹æ•°æ®ï¼ˆéæµå¼ï¼ŒåŒæ—¶ç”¨äºå›¾è¡¨å’Œè¯¦ç»†åˆ†æï¼‰
    async function fetchAIPredictionData(city, months, district) {
        const contentDiv = document.getElementById('ai-content');
        
        try {
            const response = await fetch('/api/prediction/ai-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ city, months: parseInt(months), district })
            });
            
            const result = await response.json();
            
            if (result.success && result.ai_predictions) {
                aiPredictionData = result;
                
                // æ˜¾ç¤º AI é¢„æµ‹æ‘˜è¦
                const summaryDiv = document.getElementById('ai-summary');
                const summaryContent = document.getElementById('ai-summary-content');
                
                const trendEmoji = result.trend === 'up' ? 'ğŸ“ˆ' : result.trend === 'down' ? 'ğŸ“‰' : 'â¡ï¸';
                const trendText = result.trend === 'up' ? 'ä¸Šæ¶¨' : result.trend === 'down' ? 'ä¸‹è·Œ' : 'å¹³ç¨³';
                const riskColor = result.risk_level === 'high' ? '#ef4444' : result.risk_level === 'low' ? '#10b981' : '#f59e0b';
                
                summaryContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em;">${trendEmoji}</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">è¶‹åŠ¿: ${trendText}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em;">ğŸ¯</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">ç½®ä¿¡åº¦: ${result.confidence}%</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em;">âš ï¸</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">é£é™©: <span style="color: ${riskColor}">${result.risk_level}</span></div>
                        </div>
                    </div>
                    ${result.recommendation ? `<p style="margin: 10px 0 0 0; font-size: 0.95em; opacity: 0.95;">ğŸ’¡ ${result.recommendation}</p>` : ''}
                `;
                summaryDiv.style.display = 'block';
                
                // æ¸²æŸ“ AI æ·±åº¦åˆ†æå†…å®¹ï¼ˆä½¿ç”¨åŒä¸€ä»½æ•°æ®ï¼‰
                renderAIAnalysisContent(result);
                
                // æ›´æ–°å›¾è¡¨ï¼ŒåŠ å…¥ AI é¢„æµ‹çº¿
                if (currentData && result.ai_predictions) {
                    renderPredictionChart(currentData.historical, currentData.predictions.predictions, result.ai_predictions);
                    renderTimeline(currentData.predictions.predictions, result.ai_predictions);
                }
            } else {
                contentDiv.innerHTML = `<p style="color: #fca5a5;">âŒ AI é¢„æµ‹å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</p>`;
            }
        } catch (error) {
            console.error('è·å–AIé¢„æµ‹æ•°æ®å¤±è´¥:', error);
            contentDiv.innerHTML = `<p style="color: #fca5a5;">âŒ AI é¢„æµ‹è¯·æ±‚å¤±è´¥</p>`;
        }
    }
    
    // æ¸²æŸ“ AI æ·±åº¦åˆ†æå†…å®¹
    function renderAIAnalysisContent(result) {
        const contentDiv = document.getElementById('ai-content');
        
        const predictions = result.ai_predictions;
        const trend = result.trend;
        const confidence = result.confidence;
        const riskLevel = result.risk_level;
        const keyFactors = result.key_factors || [];
        const recommendation = result.recommendation || '';
        
        // è¶‹åŠ¿ä¿¡æ¯
        const trendEmoji = trend === 'up' ? 'ğŸ“ˆ' : trend === 'down' ? 'ğŸ“‰' : 'â¡ï¸';
        const trendText = trend === 'up' ? 'ä¸Šæ¶¨è¶‹åŠ¿' : trend === 'down' ? 'ä¸‹è·Œè¶‹åŠ¿' : 'å¹³ç¨³è¶‹åŠ¿';
        const trendColor = trend === 'up' ? '#10b981' : trend === 'down' ? '#ef4444' : '#f59e0b';
        
        // è®¡ç®—ä»·æ ¼å˜åŒ–
        const firstPrice = predictions[0]?.price || 0;
        const lastPrice = predictions[predictions.length - 1]?.price || 0;
        const priceChange = ((lastPrice - firstPrice) / firstPrice * 100).toFixed(1);
        const minPrice = Math.min(...predictions.map(p => p.low || p.price));
        const maxPrice = Math.max(...predictions.map(p => p.high || p.price));
        
        let html = `
            <!-- æ€»ä½“è¶‹åŠ¿ -->
            <div style="background: linear-gradient(135deg, rgba(96,165,250,0.1), rgba(139,92,246,0.1)); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <span style="font-size: 2.5em;">${trendEmoji}</span>
                    <div>
                        <div style="font-size: 1.4em; font-weight: 600; color: ${trendColor};">${trendText}</div>
                        <div style="color: #94a3b8; font-size: 0.95em;">
                            é¢„è®¡${predictions.length}ä¸ªæœˆå†…ä»·æ ¼å˜åŒ– <strong style="color: ${trendColor}">${priceChange > 0 ? '+' : ''}${priceChange}%</strong>
                        </div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                    <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 0.85em; color: #94a3b8;">ç½®ä¿¡åº¦</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #60a5fa;">${confidence}%</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 0.85em; color: #94a3b8;">é£é™©ç­‰çº§</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: ${riskLevel === 'high' ? '#ef4444' : riskLevel === 'low' ? '#10b981' : '#f59e0b'};">
                            ${riskLevel === 'high' ? 'é«˜' : riskLevel === 'low' ? 'ä½' : 'ä¸­'}
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 0.85em; color: #94a3b8;">ä»·æ ¼åŒºé—´</div>
                        <div style="font-size: 1.1em; font-weight: 600; color: #a78bfa;">${minPrice.toFixed(0)}-${maxPrice.toFixed(0)}ä¸‡</div>
                    </div>
                </div>
            </div>
            
            <!-- æœˆåº¦é¢„æµ‹æ˜ç»† -->
            <div style="margin-bottom: 20px;">
                <h4 style="color: #60a5fa; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <span>ğŸ“…</span> æœˆåº¦é¢„æµ‹æ˜ç»†
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
        `;
        
        predictions.forEach((p, i) => {
            const prevPrice = i > 0 ? predictions[i-1].price : firstPrice;
            const monthChange = ((p.price - prevPrice) / prevPrice * 100).toFixed(1);
            const changeColor = monthChange > 0 ? '#10b981' : monthChange < 0 ? '#ef4444' : '#64748b';
            
            html += `
                <div style="background: rgba(30,41,59,0.6); border-radius: 10px; padding: 14px; text-align: center; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="color: #94a3b8; font-size: 0.85em; margin-bottom: 5px;">${p.month}</div>
                    <div style="font-size: 1.4em; font-weight: 700; color: #f1f5f9;">${p.price.toFixed(1)}<span style="font-size: 0.6em; color: #64748b;">ä¸‡</span></div>
                    <div style="font-size: 0.8em; color: #64748b; margin: 4px 0;">${(p.low || p.price).toFixed(0)} - ${(p.high || p.price).toFixed(0)}ä¸‡</div>
                    <div style="font-size: 0.85em; color: ${changeColor};">
                        ${monthChange > 0 ? 'â†‘' : monthChange < 0 ? 'â†“' : 'â†’'} ${Math.abs(monthChange)}%
                    </div>
                </div>
            `;
        });
        
        html += '</div></div>';
        
        // å…³é”®å› ç´ 
        if (keyFactors.length > 0) {
            html += `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #60a5fa; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ”‘</span> å…³é”®å½±å“å› ç´ 
                    </h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            `;
            keyFactors.forEach(factor => {
                html += `<span style="background: rgba(251,191,36,0.15); color: #fbbf24; padding: 8px 14px; border-radius: 20px; font-size: 0.9em; border: 1px solid rgba(251,191,36,0.3);">${factor}</span>`;
            });
            html += '</div></div>';
        }
        
        // æŠ•èµ„å»ºè®®
        if (recommendation) {
            html += `
                <div style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(6,182,212,0.1)); border-left: 4px solid #10b981; padding: 18px; border-radius: 0 12px 12px 0;">
                    <h4 style="color: #10b981; margin: 0 0 10px 0; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ’¡</span> AI å»ºè®®
                    </h4>
                    <p style="margin: 0; color: #e2e8f0; line-height: 1.6;">${recommendation}</p>
                </div>
            `;
        }
        
        contentDiv.innerHTML = html;
    }
    
    // æ¸²æŸ“ç»Ÿè®¡é¢„æµ‹ç»“æœ
    function renderStatsPrediction(data) {
        const factors = data.factors;
        const predictions = data.predictions;
        const districts = data.districts;
        
        // è¶‹åŠ¿æŒ‡ç¤ºå™¨
        const trendValue = document.getElementById('trend-value');
        const trendDirection = document.getElementById('trend-direction');
        const trendDesc = document.getElementById('trend-desc');
        
        const trendPct = predictions.trend_pct;
        trendValue.textContent = (trendPct > 0 ? '+' : '') + trendPct.toFixed(1) + '%';
        trendValue.className = 'trend-value ' + (trendPct > 1 ? 'trend-up' : trendPct < -1 ? 'trend-down' : 'trend-stable');
        trendDirection.textContent = trendPct > 1 ? 'ğŸ“ˆ ä¸Šæ¶¨è¶‹åŠ¿' : trendPct < -1 ? 'ğŸ“‰ ä¸‹è·Œè¶‹åŠ¿' : 'â¡ï¸ å¹³ç¨³è¿è¡Œ';
        trendDesc.textContent = `å½“å‰å‡ä»· ${predictions.base_price} ä¸‡å…ƒ`;
        
        // å¸‚åœºå› ç´ 
        document.getElementById('factor-heat').textContent = factors.market_heat + '/100';
        document.getElementById('factor-stability').textContent = factors.stability_score + '/100';
        document.getElementById('factor-volume').textContent = (factors.volume_trend > 0 ? '+' : '') + factors.volume_trend.toFixed(1) + '%';
        
        // æ¸²æŸ“é¢„æµ‹å›¾è¡¨ï¼ˆåˆå§‹åªæœ‰ç»Ÿè®¡é¢„æµ‹ï¼ŒAIé¢„æµ‹æ•°æ®åŠ è½½åä¼šæ›´æ–°ï¼‰
        renderPredictionChart(data.historical, predictions.predictions, aiPredictionData?.ai_predictions || null);
        
        // æ¸²æŸ“åŒºåŸŸæ’å
        renderDistrictList(districts);
        
        // æ¸²æŸ“æ—¶é—´çº¿ï¼ˆç»“åˆç»Ÿè®¡å’ŒAIé¢„æµ‹ï¼‰
        renderTimeline(predictions.predictions, aiPredictionData?.ai_predictions || null);
    }
    
    // æ¸²æŸ“é¢„æµ‹å›¾è¡¨ï¼ˆæ”¯æŒ AI é¢„æµ‹å¯¹æ¯”ï¼‰
    function renderPredictionChart(historical, statsPredictions, aiPredictions = null) {
        const container = document.getElementById('prediction-chart');
        
        if (predictionChart) {
            predictionChart.dispose();
        }
        
        predictionChart = echarts.init(container);
        
        // å‡†å¤‡å†å²æ•°æ®
        const historyMonths = historical.map(h => h['å¹´æœˆ']);
        const historyPrices = historical.map(h => h['å‡ä»·']);
        
        // å‡†å¤‡ç»Ÿè®¡é¢„æµ‹æ•°æ®
        const statsPredMonths = statsPredictions.map(p => p.month);
        const statsPredPrices = statsPredictions.map(p => p.predicted_price);
        
        // åˆå¹¶æ—¶é—´è½´
        const allMonths = [...historyMonths, ...statsPredMonths];
        
        // å†å²æ•°æ®çº¿ï¼ˆé¢„æµ‹æœŸå¡«å…… nullï¼‰
        const historyLine = [...historyPrices, ...Array(statsPredMonths.length).fill(null)];
        
        // ç»Ÿè®¡é¢„æµ‹çº¿ï¼ˆå†å²æœŸå¡«å…… nullï¼Œä»æœ€åä¸€ä¸ªå†å²ç‚¹å¼€å§‹è¿æ¥ï¼‰
        const statsLine = [...Array(historyMonths.length - 1).fill(null), historyPrices[historyPrices.length - 1], ...statsPredPrices];
        
        // å‡†å¤‡ AI é¢„æµ‹çº¿å’ŒåŒºé—´
        let aiLine = null;
        let aiHighLine = null;
        let aiLowLine = null;
        
        if (aiPredictions && aiPredictions.length > 0) {
            console.log('AIé¢„æµ‹æ•°æ®:', aiPredictions);
            
            // åˆ›å»º AI é¢„æµ‹æ•°æ®æ˜ å°„ï¼ˆåŒ…å« price, high, lowï¼‰
            const aiDataMap = {};
            aiPredictions.forEach(p => {
                aiDataMap[p.month] = {
                    price: p.price,
                    high: p.high,
                    low: p.low
                };
            });
            
            // åˆå§‹åŒ–ä¸‰æ¡çº¿ï¼šä¸»é¢„æµ‹çº¿ã€ä¸Šé™çº¿ã€ä¸‹é™çº¿
            const histLen = historyMonths.length;
            const lastHistPrice = historyPrices[historyPrices.length - 1];
            
            aiLine = new Array(histLen - 1).fill(null);
            aiHighLine = new Array(histLen - 1).fill(null);
            aiLowLine = new Array(histLen - 1).fill(null);
            
            // ä»æœ€åä¸€ä¸ªå†å²ç‚¹å¼€å§‹è¿æ¥
            aiLine.push(lastHistPrice);
            aiHighLine.push(lastHistPrice);
            aiLowLine.push(lastHistPrice);
            
            // æŒ‰ç…§ç»Ÿè®¡é¢„æµ‹çš„æœˆä»½é¡ºåºå¡«å…… AI é¢„æµ‹å€¼
            statsPredMonths.forEach(month => {
                const aiData = aiDataMap[month];
                if (aiData) {
                    aiLine.push(aiData.price);
                    aiHighLine.push(aiData.high);
                    aiLowLine.push(aiData.low);
                } else {
                    aiLine.push(null);
                    aiHighLine.push(null);
                    aiLowLine.push(null);
                }
            });
            
            console.log('=== AIé¢„æµ‹çº¿æ„å»º ===');
            console.log('aiLine:', aiLine);
            console.log('aiHighLine:', aiHighLine);
            console.log('aiLowLine:', aiLowLine);
        }
        
        // å›¾è¡¨é…ç½®
        const series = [
            {
                name: 'å†å²ä»·æ ¼',
                type: 'line',
                data: historyLine,
                smooth: true,
                lineStyle: { color: '#667eea', width: 3 },
                itemStyle: { color: '#667eea' },
                symbol: 'circle',
                symbolSize: 6
            },
            {
                name: 'ç»Ÿè®¡é¢„æµ‹',
                type: 'line',
                data: statsLine,
                smooth: true,
                lineStyle: { color: '#f59e0b', width: 2, type: 'dashed' },
                itemStyle: { color: '#f59e0b' },
                symbol: 'diamond',
                symbolSize: 8
            }
        ];
        
        // å¦‚æœæœ‰ AI é¢„æµ‹æ•°æ®ï¼Œæ·»åŠ åˆ°å›¾è¡¨ï¼ˆåŒ…å«é¢„æµ‹åŒºé—´ï¼‰
        if (aiLine && aiHighLine && aiLowLine) {
            // AI é¢„æµ‹åŒºé—´ä¸‹é™ï¼ˆç”¨äºå †å ï¼‰
            series.push({
                name: 'AIåŒºé—´ä¸‹é™',
                type: 'line',
                data: aiLowLine,
                smooth: true,
                lineStyle: { opacity: 0 },
                itemStyle: { opacity: 0 },
                symbol: 'none',
                stack: 'ai-confidence',
                areaStyle: { opacity: 0 }
            });
            
            // AI é¢„æµ‹åŒºé—´ï¼ˆhigh - low çš„å·®å€¼ï¼Œå †å åœ¨ä¸‹é™ä¹‹ä¸Šå½¢æˆåŒºé—´ï¼‰
            const aiRangeData = aiHighLine.map((high, i) => {
                if (high !== null && aiLowLine[i] !== null) {
                    return high - aiLowLine[i];
                }
                return null;
            });
            
            series.push({
                name: 'AIé¢„æµ‹åŒºé—´',
                type: 'line',
                data: aiRangeData,
                smooth: true,
                lineStyle: { opacity: 0 },
                itemStyle: { opacity: 0 },
                symbol: 'none',
                stack: 'ai-confidence',
                areaStyle: {
                    color: 'rgba(16, 185, 129, 0.15)'
                }
            });
            
            // AI ä¸»é¢„æµ‹çº¿
            series.push({
                name: 'AIé¢„æµ‹',
                type: 'line',
                data: aiLine,
                smooth: true,
                lineStyle: { color: '#10b981', width: 3 },
                itemStyle: { color: '#10b981' },
                symbol: 'triangle',
                symbolSize: 10,
                z: 10  // ç¡®ä¿åœ¨åŒºé—´ä¹‹ä¸Š
            });
        }
        
        const legendData = ['å†å²ä»·æ ¼', 'ç»Ÿè®¡é¢„æµ‹'];
        if (aiLine) {
            legendData.push('AIé¢„æµ‹');
            legendData.push('AIé¢„æµ‹åŒºé—´');
        }
        
        const option = {
            tooltip: {
                trigger: 'axis',
                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                borderColor: 'rgba(255,255,255,0.1)',
                textStyle: { color: '#fff' },
                formatter: function(params) {
                    if (!params || params.length === 0) return '';
                    
                    let result = `<strong>${params[0].axisValue}</strong><br/>`;
                    let aiPredValue = null;
                    let aiHighValue = null;
                    let aiLowValue = null;
                    
                    params.forEach(p => {
                        const val = p.value;
                        const isValidNumber = typeof val === 'number' && !isNaN(val);
                        
                        // è·³è¿‡è¾…åŠ©çº¿ï¼ˆåŒºé—´ä¸‹é™å’ŒåŒºé—´å·®å€¼ï¼‰
                        if (p.seriesName === 'AIåŒºé—´ä¸‹é™') {
                            if (isValidNumber) aiLowValue = val;
                            return;
                        }
                        if (p.seriesName === 'AIé¢„æµ‹åŒºé—´') {
                            // è¿™æ˜¯å·®å€¼ï¼Œéœ€è¦åŠ ä¸Šä¸‹é™å¾—åˆ°ä¸Šé™
                            if (isValidNumber && aiLowValue !== null) {
                                aiHighValue = aiLowValue + val;
                            }
                            return;
                        }
                        
                        if (p.seriesName === 'AIé¢„æµ‹' && isValidNumber) {
                            aiPredValue = val;
                        }
                        
                        // åªæ˜¾ç¤ºæœ‰æ•ˆæ•°å€¼
                        if (isValidNumber) {
                            result += `${p.marker} ${p.seriesName}: <strong>${val.toFixed(1)}</strong> ä¸‡å…ƒ<br/>`;
                        }
                    });
                    
                    // æ·»åŠ  AI é¢„æµ‹åŒºé—´ä¿¡æ¯
                    if (aiPredValue !== null && aiHighValue !== null && aiLowValue !== null) {
                        result += `<span style="color: #94a3b8; font-size: 0.9em;">ã€€ã€€é¢„æµ‹åŒºé—´: ${aiLowValue.toFixed(1)} - ${aiHighValue.toFixed(1)} ä¸‡å…ƒ</span><br/>`;
                    }
                    
                    return result;
                }
            },
            legend: {
                data: legendData,
                textStyle: { color: '#64748b' },
                top: 10
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '15%',
                top: '15%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: allMonths,
                axisLabel: {
                    rotate: 45,
                    fontSize: 10
                },
                axisTick: { alignWithLabel: true }
            },
            yAxis: {
                type: 'value',
                name: 'å‡ä»·ï¼ˆä¸‡å…ƒï¼‰',
                nameTextStyle: { color: '#64748b' },
                axisLabel: {
                    formatter: '{value}',
                    color: '#64748b'
                },
                splitLine: {
                    lineStyle: { color: '#e2e8f0', type: 'dashed' }
                }
            },
            series: series
        };
        
        // ä½¿ç”¨ notMerge: true ç¡®ä¿å®Œå…¨é‡ç»˜ï¼ˆç‰¹åˆ«æ˜¯æ·»åŠ  AI é¢„æµ‹çº¿æ—¶ï¼‰
        predictionChart.setOption(option, { notMerge: true });
        
        console.log('å›¾è¡¨å·²æ¸²æŸ“, seriesæ•°é‡:', series.length, 'legend:', legendData);
        
        // å“åº”å¼
        window.addEventListener('resize', () => predictionChart.resize());
    }
    
    // æ¸²æŸ“åŒºåŸŸæ’å
    function renderDistrictList(districts) {
        const container = document.getElementById('district-list');
        
        if (!districts || districts.length === 0) {
            container.innerHTML = '<p style="color: #94a3b8; text-align: center;">æš‚æ— åŒºåŸŸæ•°æ®</p>';
            return;
        }
        
        container.innerHTML = districts.slice(0, 10).map((d, i) => `
            <div class="district-item">
                <span class="district-rank">${i + 1}</span>
                <span class="district-name">${d.name}</span>
                <span class="district-price">${d.latest_price}ä¸‡</span>
                <span class="district-change ${d.total_change > 0 ? 'up' : 'down'}">
                    ${d.total_change > 0 ? '+' : ''}${d.total_change.toFixed(1)}%
                </span>
            </div>
        `).join('');
    }
    
    // æ¸²æŸ“æ—¶é—´çº¿ï¼ˆå¯¹æ¯”ç»Ÿè®¡å’ŒAIé¢„æµ‹ï¼‰
    function renderTimeline(statsPredictions, aiPredictions = null) {
        const container = document.getElementById('timeline-grid');
        
        // åˆ›å»º AI é¢„æµ‹æ˜ å°„
        const aiPriceMap = {};
        if (aiPredictions) {
            aiPredictions.forEach(p => {
                aiPriceMap[p.month] = p;
            });
        }
        
        container.innerHTML = statsPredictions.map(p => {
            const aiP = aiPriceMap[p.month];
            const hasAI = aiP && aiP.price;
            
            // è®¡ç®—å·®å¼‚
            let diffHtml = '';
            if (hasAI) {
                const diff = aiP.price - p.predicted_price;
                const diffPct = (diff / p.predicted_price * 100).toFixed(1);
                const diffColor = diff > 0 ? '#10b981' : diff < 0 ? '#ef4444' : '#64748b';
                diffHtml = `
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e2e8f0;">
                        <div style="font-size: 0.8em; color: #64748b;">ğŸ¤– AIé¢„æµ‹</div>
                        <div style="font-size: 1.1em; font-weight: 600; color: #10b981;">${aiP.price.toFixed(1)}ä¸‡</div>
                        <div style="font-size: 0.75em; color: ${diffColor};">
                            ${diff > 0 ? 'â†‘' : diff < 0 ? 'â†“' : '='} ${Math.abs(diff).toFixed(1)}ä¸‡ (${diff > 0 ? '+' : ''}${diffPct}%)
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="timeline-item">
                    <div class="timeline-month">${p.month}</div>
                    <div style="font-size: 0.8em; color: #f59e0b; margin-bottom: 3px;">ğŸ“Š ç»Ÿè®¡é¢„æµ‹</div>
                    <div class="timeline-price">${p.predicted_price}ä¸‡</div>
                    <div class="timeline-range">${p.range_low} - ${p.range_high}ä¸‡</div>
                    <div class="timeline-confidence">
                        ç½®ä¿¡åº¦ ${p.confidence}%
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${p.confidence}%"></div>
                        </div>
                    </div>
                    ${diffHtml}
                </div>
            `;
        }).join('');
    }
    
</script>
{% endblock %}

