<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ city_name }} - 房价深度分析报告</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/analysis.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/role_selector.css') }}">
</head>
<body>
    <div class="analysis-container">
        <div class="analysis-header">
            <div class="header-content">
                <a href="/" class="back-btn">← 返回首页</a>
                <h1>{{ city_name }} 房价深度分析报告</h1>
                <p class="subtitle">基于 2023-2025 年真实成交数据的专业分析</p>
            </div>
            <!-- 用户信息 -->
            <div style="position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 15px;">
                {% if user %}
                <span style="color: #64748b; font-size: 0.9em;">
                    👤 {{ user.username }} 
                    <span id="user-role-badge" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 3px 10px;
                        border-radius: 12px;
                        font-size: 0.8em;
                        margin-left: 5px;
                    "></span>
                </span>
                {% endif %}
            </div>
        </div>

        <div id="loading-analysis" class="loading-section">
            <div class="spinner"></div>
            <p>正在进行深度数据分析...</p>
        </div>

        <div id="analysis-content" style="display: none;">
            
            <!-- AI智能概览 -->
            <div class="analysis-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 30px; margin-bottom: 30px; color: white;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <span style="font-size: 2.5em;">🤖</span>
                    <div>
                        <h2 style="margin: 0; color: white;">AI 智能概览</h2>
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em;"><span id="analysis-city-name-ai">{{ city_name }}</span> · DeepSeek-V3 深度分析</p>
                    </div>
                    <button id="quick-insight-btn" onclick="loadQuickAIInsight()" style="
                        background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
                        color: white;
                        border: none;
                        padding: 10px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 0.95em;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
                        margin-left: auto;
                        margin-right: 10px;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.2)'">
                        ⚡ 一键AI洞察
                    </button>
                    <button onclick="refreshCityAIOverview()" style="
                        background: rgba(255,255,255,0.2);
                        border: 1px solid rgba(255,255,255,0.5);
                        color: white;
                        padding: 8px 20px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 0.9em;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                       onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        🔄 刷新分析
                    </button>
                </div>
                <div id="city-ai-overview-content" style="
                    background: rgba(255,255,255,0.15);
                    backdrop-filter: blur(10px);
                    padding: 25px;
                    border-radius: 12px;
                    line-height: 1.8;
                    font-size: 1.05em;
                    min-height: 120px;
                ">
                    <div class="spinner" style="margin: 40px auto;"></div>
                    <p style="text-align: center;">AI正在分析数据...</p>
                </div>
                <div id="quick-insight-content" style="display: none; margin-top: 20px;"></div>
            </div>
            
            <!-- 投资指数卡片 - 仅投资顾问和改善型购房者可见 -->
            <div class="analysis-section role-filter" data-hide-for="first_time_buyer">
            <div class="index-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">📊 综合投资指数</h2>
                    <button onclick="toggleIndexExplanation()" style="
                        background: transparent;
                        border: 1px solid #667eea;
                        color: #667eea;
                        padding: 5px 15px;
                        border-radius: 15px;
                        cursor: pointer;
                        font-size: 0.85em;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='#667eea'; this.style.color='white'" 
                       onmouseout="this.style.background='transparent'; this.style.color='#667eea'">
                        💡 查看计算方法
                    </button>
                </div>
                
                <!-- 计算说明（默认隐藏） -->
                <div id="index-explanation" style="
                    display: none;
                    background: #f8fafc;
                    padding: 20px;
                    border-radius: 10px;
                    margin-bottom: 20px;
                    border-left: 4px solid #667eea;
                    font-size: 0.9em;
                    line-height: 1.8;
                ">
                    <h4 style="margin-top: 0; color: #667eea;">投资指数计算方法说明</h4>
                    
                    <p><strong>1. 价格趋势分数（40%权重）</strong></p>
                    <p style="margin-left: 20px; color: #64748b;">
                        对比最近6个月与之前6个月的均价变化率<br>
                        公式：(最近6月均价 - 之前6月均价) / 之前6月均价 × 100<br>
                        正值表示上涨，负值表示下跌
                    </p>
                    
                    <p><strong>2. 成交量趋势分数（20%权重）</strong></p>
                    <p style="margin-left: 20px; color: #64748b;">
                        对比最近6个月与之前6个月的成交量变化率<br>
                        正值表示市场活跃度提升，负值表示活跃度下降
                    </p>
                    
                    <p><strong>3. 市场稳定性分数（40%权重）</strong></p>
                    <p style="margin-left: 20px; color: #64748b;">
                        基于价格变异系数(CV)计算：CV = 标准差/均值 × 100%<br>
                        公式：100 / (1 + CV/10)<br>
                        CV越小，市场越稳定，分数越高<br>
                        <span style="color: #10b981;">● CV&lt;30%：稳定</span> 
                        <span style="color: #f59e0b;">● 30-50%：一般</span> 
                        <span style="color: #ef4444;">● &gt;50%：波动较大</span>
                    </p>
                    
                    <p><strong>4. 综合评分</strong></p>
                    <p style="margin-left: 20px; color: #64748b;">
                        加权平均后归一化到0-100分<br>
                        <span style="color: #10b981;">● 80-100分：优秀</span>
                        <span style="color: #667eea;">● 60-79分：良好</span>
                        <span style="color: #f59e0b;">● 40-59分：一般</span>
                        <span style="color: #ef4444;">● 0-39分：较差</span>
                    </p>
                </div>
                
                <div class="index-score-container">
                    <div class="index-score" id="investment-score">--</div>
                    <div class="index-level" id="investment-level">--</div>
                </div>
                <div class="index-breakdown">
                    <div class="breakdown-item">
                        <span>价格趋势</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="price-trend-bar"></div>
                        </div>
                        <span id="price-trend-score">--</span>
                    </div>
                    <div class="breakdown-item">
                        <span>成交量趋势</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="volume-trend-bar"></div>
                        </div>
                        <span id="volume-trend-score">--</span>
                    </div>
                    <div class="breakdown-item">
                        <span>市场稳定性</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="stability-bar"></div>
                        </div>
                        <span id="stability-score">--</span>
                    </div>
                </div>
                <div class="recommendation" id="recommendation">--</div>
                
                <!-- 计算详情 -->
                <div id="calculation-details" style="
                    margin-top: 20px;
                    padding: 15px;
                    background: #f8fafc;
                    border-radius: 8px;
                    font-size: 0.85em;
                    color: #64748b;
                    display: none;
                "></div>
                </div>
            </div>

            <script>
            function toggleIndexExplanation() {
                const explanation = document.getElementById('index-explanation');
                if (explanation.style.display === 'none') {
                    explanation.style.display = 'block';
                } else {
                    explanation.style.display = 'none';
                }
            }
            </script>

            <!-- 基础统计 - 所有角色可见 -->
            <div class="analysis-section">
                <h2>📈 基础统计分析</h2>
                <div class="stats-grid" id="basic-stats"></div>
            </div>

            <!-- 价格分布箱线图 - 仅投资顾问和改善型购房者可见 -->
            <div class="analysis-section role-filter" data-hide-for="first_time_buyer">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">📊 价格分布统计（箱线图）</h2>
                    <button class="ai-analyze-btn" onclick="analyzeChart('boxplot')" style="
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                        color: white;
                        border: none;
                        padding: 8px 20px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 0.9em;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        🤖 AI分析此图表
                    </button>
                </div>
                <div class="chart-container" id="price-boxplot" style="height: 350px;"></div>
                <div id="boxplot-ai-insight" class="ai-insight" style="display: none;"></div>
                <div style="margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; font-size: 0.9em; color: #64748b;">
                    <strong>💡 如何阅读箱线图：</strong><br>
                    • 箱体代表中间50%的数据（Q1-Q3）<br>
                    • 箱体中的线是中位数<br>
                    • 上下须代表最大值和最小值<br>
                    • 红点是平均值
                </div>
            </div>

            <!-- 投资评分雷达图 - 仅投资顾问和改善型购房者可见 -->
            <div class="analysis-section role-filter" data-hide-for="first_time_buyer">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">🎯 投资综合评分雷达图</h2>
                    <button class="ai-analyze-btn" onclick="analyzeChart('radar')" style="
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        padding: 8px 20px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 0.9em;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        🤖 AI分析此图表
                    </button>
                </div>
                <div class="chart-container" id="investment-radar" style="height: 400px;"></div>
                <div id="radar-ai-insight" class="ai-insight" style="display: none;"></div>
            </div>

            <!-- 价格趋势 - 所有角色可见 -->
            <div class="analysis-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">📉 价格趋势分析</h2>
                    <button class="ai-analyze-btn" onclick="analyzeChart('trend')" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 8px 20px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 0.9em;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        🤖 AI分析此图表
                    </button>
                </div>
                <div class="trend-summary" id="trend-summary"></div>
                <div class="chart-container" id="trend-chart" style="height: 450px;"></div>
                <div id="trend-ai-insight" class="ai-insight" style="display: none;"></div>
            </div>

            <!-- 波动性分析 - 所有角色可见 -->
            <div class="analysis-section">
                <h2>💹 市场波动性分析</h2>
                <div id="volatility-analysis"></div>
            </div>

            <!-- 市场活跃度 - 所有角色可见 -->
            <div class="analysis-section">
                <h2>🔥 市场活跃度分析</h2>
                <div id="market-activity"></div>
            </div>

            <!-- 同比分析 - 仅投资顾问和改善型购房者可见 -->
            <div class="analysis-section role-filter" data-hide-for="first_time_buyer">
                <h2>📊 年度同比分析（增长率对比）</h2>
                <div class="table-wrapper">
                    <table id="yoy-table"></table>
                </div>
            </div>

            <!-- 价格区间分布 - 所有角色可见 -->
            <div class="analysis-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">💰 价格区间分布</h2>
                    <button class="ai-analyze-btn" onclick="analyzeChart('priceRange')" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 8px 20px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 0.9em;
                        display: flex;
                        align-items: center;
                        gap: 5px;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        🤖 AI分析此图表
                    </button>
                </div>
                <div class="chart-container" id="price-range-chart" style="height: 400px;"></div>
                <div id="priceRange-ai-insight" class="ai-insight" style="display: none;"></div>
            </div>

            <!-- 面积分布 - 所有角色可见 -->
            <div class="analysis-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">🏠 户型面积分布</h2>
                    <button class="ai-analyze-btn" onclick="analyzeChart('area')" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 8px 20px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 0.9em;
                        display: flex;
                        align-items: center;
                        gap: 5px;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        🤖 AI分析此图表
                    </button>
                </div>
                <div class="chart-container" id="area-chart" style="height: 400px;"></div>
                <div id="area-ai-insight" class="ai-insight" style="display: none;"></div>
            </div>

            <!-- 价格小提琴图 - 仅投资顾问和改善型购房者可见 -->
            <div class="analysis-section role-filter" data-hide-for="first_time_buyer">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">🎻 价格分布小提琴图</h2>
                    <button onclick="analyzeChart('violin')" style="
                        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                        color: white;
                        border: none;
                        padding: 8px 20px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 0.9em;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" 
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                        🤖 AI分析此图表
                    </button>
                </div>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #8b5cf6;">
                    <strong style="color: #8b5cf6;">💡 什么是小提琴图？</strong>
                    <p style="margin: 5px 0 0 0; color: #64748b; font-size: 0.9em;">
                        小提琴图结合了箱线图和密度图的优点，"胖"的部分表示该价格段房源多，"瘦"的部分表示房源少，能更直观地看出价格集中区间。
                    </p>
                </div>
                <div id="price-violin" style="width: 100%; height: 400px;"></div>
                <div id="violin-ai-insight" style="display: none; margin-top: 20px;"></div>
            </div>
            
            <!-- 区域价格热力图 - 所有角色可见 -->
            <div class="analysis-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">🗺️ 区域-时间价格热力图</h2>
                    <button onclick="analyzeChart('heatmap')" style="
                        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
                        color: white;
                        border: none;
                        padding: 8px 20px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 0.9em;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" 
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                        🤖 AI分析此图表
                    </button>
                </div>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #06b6d4;">
                    <strong style="color: #06b6d4;">💡 如何阅读热力图？</strong>
                    <p style="margin: 5px 0 0 0; color: #64748b; font-size: 0.9em;">
                        颜色越深表示该区域在该时间段的价格越高。横向看区域随时间的变化，纵向看不同区域在同一时间的差异。
                    </p>
                </div>
                <div id="district-heatmap" style="width: 100%; height: 600px;"></div>
                <div id="heatmap-ai-insight" style="display: none; margin-top: 20px;"></div>
            </div>
            
            <!-- 价格变化瀑布图 - 仅投资顾问和改善型购房者可见 -->
            <div class="analysis-section role-filter" data-hide-for="first_time_buyer">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">📊 价格变化因素拆解</h2>
                    <button onclick="analyzeChart('waterfall')" style="
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                        color: white;
                        border: none;
                        padding: 8px 20px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 0.9em;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" 
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                        🤖 AI分析此图表
                    </button>
                </div>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                    <strong style="color: #f59e0b;">💡 瀑布图说明</strong>
                    <p style="margin: 5px 0 0 0; color: #64748b; font-size: 0.9em;">
                        瀑布图展示价格从起始到结束的变化路径，将总变化拆解为市场趋势、区域发展、政策影响等因素，绿色表示上涨，红色表示下跌。
                    </p>
                </div>
                <div id="price-waterfall" style="width: 100%; height: 450px;"></div>
                <div id="waterfall-ai-insight" style="display: none; margin-top: 20px;"></div>
            </div>
            
            <!-- 区域深度分析 - 所有角色可见 -->
            <div class="analysis-section">
                <h2>🗺️ 区域深度分析（Top 15）</h2>
                <div class="table-wrapper">
                    <table id="district-table"></table>
                </div>
            </div>

            <!-- 季节性分析 - 仅投资顾问和改善型购房者可见 -->
            <div class="analysis-section role-filter" data-hide-for="first_time_buyer">
                <h2>🌸 季节性特征分析</h2>
                <div id="seasonal-analysis"></div>
            </div>

        </div>

        <div class="analysis-footer">
            <p>数据来源：贝壳找房 | 分析时间：<span id="analysis-time"></span></p>
            <p>⚠️ 本报告仅供参考，不构成投资建议。投资有风险，决策需谨慎。</p>
        </div>
    </div>

    <!-- 图表库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script>
        const cityNameEn = '{{ city_name_en }}';
        const cityName = '{{ city_name }}';
    </script>
    <script src="{{ url_for('static', filename='js/user_role.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chart_ai.js') }}"></script>
    <script src="{{ url_for('static', filename='js/echarts_renderer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/quick_insight.js') }}"></script>
    <script src="{{ url_for('static', filename='js/analysis.js') }}"></script>
    
    <script>
        // 根据用户角色过滤内容
        async function applyRoleFilter() {
            const role = await ensureRoleLoaded();
            console.log('[Analysis] 当前用户角色:', role);
            
            // 更新角色徽章显示
            const roleBadge = document.getElementById('user-role-badge');
            if (roleBadge) {
                const roleNames = {
                    'investment_advisor': '💼 投资顾问',
                    'first_time_buyer': '🏠 首次购房者',
                    'upgrader': '🏡 改善型购房者'
                };
                roleBadge.textContent = roleNames[role] || role;
            }
            
            // 根据角色隐藏不需要的内容
            const hideElements = document.querySelectorAll('.role-filter');
            hideElements.forEach(el => {
                const hideFor = el.getAttribute('data-hide-for');
                if (hideFor && hideFor.includes(role)) {
                    el.style.display = 'none';
                    console.log('[Analysis] 隐藏元素:', el.querySelector('h2')?.textContent);
                } else {
                    el.style.display = 'block';
                }
            });
        }
        
        // 加载 AI 概览（流式）
        async function loadCityAIOverview() {
            const contentDiv = document.getElementById('city-ai-overview-content');
            contentDiv.innerHTML = '<p style="opacity: 0.8; text-align: center;">🤖 AI正在分析中...</p>';
            
            const role = await ensureRoleLoaded() || 'investment_advisor';
            console.log('[Analysis] 加载AI概览，角色:', role);
            
            const eventSource = new EventSource(`/api/city/${cityNameEn}/ai-overview-stream?role=${role}`);
            let fullText = '';
            
            eventSource.onmessage = function(event) {
                if (event.data === '[DONE]') {
                    eventSource.close();
                    return;
                }
                
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.error) {
                        contentDiv.innerHTML = `<p style="opacity: 0.8;">❌ ${data.error}</p>`;
                        eventSource.close();
                        return;
                    }
                    
                    if (data.content) {
                        fullText += data.content;
                        const paragraphs = fullText.split('\n').filter(p => p.trim());
                        contentDiv.innerHTML = paragraphs.map(p => 
                            `<p style="margin: 10px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">${p}</p>`
                        ).join('');
                    }
                } catch (e) {
                    console.error('解析SSE数据错误:', e);
                }
            };
            
            eventSource.onerror = function(error) {
                console.error('SSE错误:', error);
                if (!fullText) {
                    contentDiv.innerHTML = '<p style="opacity: 0.8;">AI分析加载失败，请点击刷新重试</p>';
                }
                eventSource.close();
            };
        }
        
        // 刷新AI概览
        function refreshCityAIOverview() {
            loadCityAIOverview();
        }
        
        // 一键AI洞察
        async function loadQuickAIInsight() {
            const role = await ensureRoleLoaded() || 'investment_advisor';
            if (typeof generateQuickInsight === 'function') {
                generateQuickInsight();
            } else {
                console.error('generateQuickInsight 函数未定义');
            }
        }
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', async function() {
            // 等待角色加载
            await ensureRoleLoaded();
            
            // 应用角色过滤
            applyRoleFilter();
            
            // 加载AI概览（延迟一点确保数据加载完成）
            setTimeout(() => {
                loadCityAIOverview();
            }, 1000);
        });
        
        // 数据加载完成后再次应用过滤
        document.addEventListener('analysisDataLoaded', function() {
            applyRoleFilter();
        });
    </script>
</body>
</html>
