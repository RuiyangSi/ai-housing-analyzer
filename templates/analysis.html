{% extends "base_layout.html" %}

{% block title %}{{ city_name }} - æˆ¿ä»·æ·±åº¦åˆ†ææŠ¥å‘Š{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/analysis.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/role_selector.css') }}">
<style>
    .analysis-page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px;
        border-radius: 20px;
        margin-bottom: 30px;
        color: white;
        text-align: center;
    }
    
    .analysis-page-header h1 {
        margin: 0;
        font-size: 2.2em;
        font-weight: 800;
    }
    
    .analysis-page-header .subtitle {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 1.05em;
    }
    
    .user-role-badge {
        display: inline-block;
        background: rgba(255,255,255,0.2);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85em;
        margin-top: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="analysis-container" style="padding: 0;">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="analysis-page-header">
        <h1>{{ city_name }} æˆ¿ä»·æ·±åº¦åˆ†ææŠ¥å‘Š</h1>
        <p class="subtitle">åŸºäº 2023-2025 å¹´çœŸå®æˆäº¤æ•°æ®çš„ä¸“ä¸šåˆ†æ</p>
        {% if user %}
        <div class="user-role-badge">
            ğŸ‘¤ {{ user.username }} Â· <span id="user-role-badge"></span>
        </div>
        {% endif %}
    </div>

    <div id="loading-analysis" class="loading-section">
        <div class="spinner"></div>
        <p>æ­£åœ¨è¿›è¡Œæ·±åº¦æ•°æ®åˆ†æ...</p>
    </div>

    <div id="analysis-content" style="display: none;">
        
        <!-- AIæ™ºèƒ½æ¦‚è§ˆ -->
        <div class="analysis-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 30px; margin-bottom: 30px; color: white;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <span style="font-size: 2.5em;">ğŸ¤–</span>
                <div>
                    <h2 style="margin: 0; color: white;">AI æ™ºèƒ½æ¦‚è§ˆ</h2>
                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em;"><span id="analysis-city-name-ai">{{ city_name }}</span> Â· DeepSeek-V3 æ·±åº¦åˆ†æ</p>
                </div>
                <div style="margin-left: auto; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="quick-insight-btn" onclick="loadQuickAIInsight()" style="
                        background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
                        color: white;
                        border: none;
                        padding: 10px 24px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 0.95em;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        âš¡ ä¸€é”®AIæ´å¯Ÿ
                    </button>
                    <button onclick="refreshCityAIOverview()" style="
                        background: rgba(255,255,255,0.2);
                        border: 1px solid rgba(255,255,255,0.5);
                        color: white;
                        padding: 8px 20px;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 0.9em;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                       onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        ğŸ”„ åˆ·æ–°åˆ†æ
                    </button>
                </div>
            </div>
            <div id="city-ai-overview-content" style="
                background: rgba(255,255,255,0.15);
                backdrop-filter: blur(10px);
                padding: 25px;
                border-radius: 12px;
                line-height: 1.8;
                font-size: 1.05em;
                min-height: 120px;
            ">
                <div class="spinner" style="margin: 40px auto;"></div>
                <p style="text-align: center;">AIæ­£åœ¨åˆ†ææ•°æ®...</p>
            </div>
            <div id="quick-insight-content" style="display: none; margin-top: 20px;"></div>
        </div>
        
        <!-- æŠ•èµ„æŒ‡æ•°å¡ç‰‡ - ä»…æŠ•èµ„é¡¾é—®å’Œæ”¹å–„å‹è´­æˆ¿è€…å¯è§ -->
        <div class="analysis-section role-filter" data-hide-for="first_time_buyer">
        <div class="index-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">ğŸ“Š ç»¼åˆæŠ•èµ„æŒ‡æ•°</h2>
                <button onclick="toggleIndexExplanation()" style="
                    background: transparent;
                    border: 1px solid #667eea;
                    color: #667eea;
                    padding: 5px 15px;
                    border-radius: 15px;
                    cursor: pointer;
                    font-size: 0.85em;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='#667eea'; this.style.color='white'" 
                   onmouseout="this.style.background='transparent'; this.style.color='#667eea'">
                    ğŸ’¡ æŸ¥çœ‹è®¡ç®—æ–¹æ³•
                </button>
            </div>
            
            <!-- è®¡ç®—è¯´æ˜ï¼ˆé»˜è®¤éšè—ï¼‰ -->
            <div id="index-explanation" style="
                display: none;
                background: #f8fafc;
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 20px;
                border-left: 4px solid #667eea;
                font-size: 0.9em;
                line-height: 1.8;
            ">
                <h4 style="margin-top: 0; color: #667eea;">æŠ•èµ„æŒ‡æ•°è®¡ç®—æ–¹æ³•è¯´æ˜</h4>
                
                <p><strong>1. ä»·æ ¼è¶‹åŠ¿åˆ†æ•°ï¼ˆ40%æƒé‡ï¼‰</strong></p>
                <p style="margin-left: 20px; color: #64748b;">
                    å¯¹æ¯”æœ€è¿‘6ä¸ªæœˆä¸ä¹‹å‰6ä¸ªæœˆçš„å‡ä»·å˜åŒ–ç‡<br>
                    å…¬å¼ï¼š(æœ€è¿‘6æœˆå‡ä»· - ä¹‹å‰6æœˆå‡ä»·) / ä¹‹å‰6æœˆå‡ä»· Ã— 100<br>
                    æ­£å€¼è¡¨ç¤ºä¸Šæ¶¨ï¼Œè´Ÿå€¼è¡¨ç¤ºä¸‹è·Œ
                </p>
                
                <p><strong>2. æˆäº¤é‡è¶‹åŠ¿åˆ†æ•°ï¼ˆ20%æƒé‡ï¼‰</strong></p>
                <p style="margin-left: 20px; color: #64748b;">
                    å¯¹æ¯”æœ€è¿‘6ä¸ªæœˆä¸ä¹‹å‰6ä¸ªæœˆçš„æˆäº¤é‡å˜åŒ–ç‡<br>
                    æ­£å€¼è¡¨ç¤ºå¸‚åœºæ´»è·ƒåº¦æå‡ï¼Œè´Ÿå€¼è¡¨ç¤ºæ´»è·ƒåº¦ä¸‹é™
                </p>
                
                <p><strong>3. å¸‚åœºç¨³å®šæ€§åˆ†æ•°ï¼ˆ40%æƒé‡ï¼‰</strong></p>
                <p style="margin-left: 20px; color: #64748b;">
                    åŸºäºä»·æ ¼å˜å¼‚ç³»æ•°(CV)è®¡ç®—ï¼šCV = æ ‡å‡†å·®/å‡å€¼ Ã— 100%<br>
                    å…¬å¼ï¼š100 / (1 + CV/10)<br>
                    CVè¶Šå°ï¼Œå¸‚åœºè¶Šç¨³å®šï¼Œåˆ†æ•°è¶Šé«˜
                </p>
            </div>
            
            <div class="index-score-container">
                <div class="index-score" id="investment-score">--</div>
                <div class="index-level" id="investment-level">--</div>
            </div>
            <div class="index-breakdown">
                <div class="breakdown-item">
                    <span>ä»·æ ¼è¶‹åŠ¿</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="price-trend-bar"></div>
                    </div>
                    <span id="price-trend-score">--</span>
                </div>
                <div class="breakdown-item">
                    <span>æˆäº¤é‡è¶‹åŠ¿</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="volume-trend-bar"></div>
                    </div>
                    <span id="volume-trend-score">--</span>
                </div>
                <div class="breakdown-item">
                    <span>å¸‚åœºç¨³å®šæ€§</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="stability-bar"></div>
                    </div>
                    <span id="stability-score">--</span>
                </div>
            </div>
            <div class="recommendation" id="recommendation">--</div>
            </div>
        </div>

        <!-- åŸºç¡€ç»Ÿè®¡ - æ‰€æœ‰è§’è‰²å¯è§ -->
        <div class="analysis-section">
            <h2>ğŸ“ˆ åŸºç¡€ç»Ÿè®¡åˆ†æ</h2>
            <div class="stats-grid" id="basic-stats"></div>
        </div>

        <!-- ä»·æ ¼åˆ†å¸ƒç®±çº¿å›¾ - ä»…æŠ•èµ„é¡¾é—®å’Œæ”¹å–„å‹è´­æˆ¿è€…å¯è§ -->
        <div class="analysis-section role-filter" data-hide-for="first_time_buyer">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">ğŸ“Š ä»·æ ¼åˆ†å¸ƒç»Ÿè®¡ï¼ˆç®±çº¿å›¾ï¼‰</h2>
                <button class="ai-analyze-btn" onclick="analyzeChart('boxplot')" style="
                    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    color: white;
                    border: none;
                    padding: 8px 20px;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ğŸ¤– AIåˆ†ææ­¤å›¾è¡¨
                </button>
            </div>
            <div class="chart-container" id="price-boxplot" style="height: 350px;"></div>
            <div id="boxplot-ai-insight" class="ai-insight" style="display: none;"></div>
        </div>

        <!-- æŠ•èµ„è¯„åˆ†é›·è¾¾å›¾ - ä»…æŠ•èµ„é¡¾é—®å’Œæ”¹å–„å‹è´­æˆ¿è€…å¯è§ -->
        <div class="analysis-section role-filter" data-hide-for="first_time_buyer">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">ğŸ¯ æŠ•èµ„ç»¼åˆè¯„åˆ†é›·è¾¾å›¾</h2>
                <button class="ai-analyze-btn" onclick="analyzeChart('radar')" style="
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    border: none;
                    padding: 8px 20px;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ğŸ¤– AIåˆ†ææ­¤å›¾è¡¨
                </button>
            </div>
            <div class="chart-container" id="investment-radar" style="height: 400px;"></div>
            <div id="radar-ai-insight" class="ai-insight" style="display: none;"></div>
        </div>

        <!-- ä»·æ ¼è¶‹åŠ¿ - æ‰€æœ‰è§’è‰²å¯è§ -->
        <div class="analysis-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">ğŸ“‰ ä»·æ ¼è¶‹åŠ¿åˆ†æ</h2>
                <button class="ai-analyze-btn" onclick="analyzeChart('trend')" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    padding: 8px 20px;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ğŸ¤– AIåˆ†ææ­¤å›¾è¡¨
                </button>
            </div>
            <div class="trend-summary" id="trend-summary"></div>
            <div class="chart-container" id="trend-chart" style="height: 450px;"></div>
            <div id="trend-ai-insight" class="ai-insight" style="display: none;"></div>
        </div>

        <!-- æ³¢åŠ¨æ€§åˆ†æ - æ‰€æœ‰è§’è‰²å¯è§ -->
        <div class="analysis-section">
            <h2>ğŸ’¹ å¸‚åœºæ³¢åŠ¨æ€§åˆ†æ</h2>
            <div id="volatility-analysis"></div>
        </div>

        <!-- å¸‚åœºæ´»è·ƒåº¦ - æ‰€æœ‰è§’è‰²å¯è§ -->
        <div class="analysis-section">
            <h2>ğŸ”¥ å¸‚åœºæ´»è·ƒåº¦åˆ†æ</h2>
            <div id="market-activity"></div>
        </div>

        <!-- åŒæ¯”åˆ†æ - ä»…æŠ•èµ„é¡¾é—®å’Œæ”¹å–„å‹è´­æˆ¿è€…å¯è§ -->
        <div class="analysis-section role-filter" data-hide-for="first_time_buyer">
            <h2>ğŸ“Š å¹´åº¦åŒæ¯”åˆ†æï¼ˆå¢é•¿ç‡å¯¹æ¯”ï¼‰</h2>
            <div class="table-wrapper">
                <table id="yoy-table"></table>
            </div>
        </div>

        <!-- ä»·æ ¼åŒºé—´åˆ†å¸ƒ - æ‰€æœ‰è§’è‰²å¯è§ -->
        <div class="analysis-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">ğŸ’° ä»·æ ¼åŒºé—´åˆ†å¸ƒ</h2>
                <button class="ai-analyze-btn" onclick="analyzeChart('priceRange')" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    padding: 8px 20px;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ğŸ¤– AIåˆ†ææ­¤å›¾è¡¨
                </button>
            </div>
            <div class="chart-container" id="price-range-chart" style="height: 400px;"></div>
            <div id="priceRange-ai-insight" class="ai-insight" style="display: none;"></div>
        </div>

        <!-- é¢ç§¯åˆ†å¸ƒ - æ‰€æœ‰è§’è‰²å¯è§ -->
        <div class="analysis-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">ğŸ  æˆ·å‹é¢ç§¯åˆ†å¸ƒ</h2>
                <button class="ai-analyze-btn" onclick="analyzeChart('area')" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    padding: 8px 20px;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ğŸ¤– AIåˆ†ææ­¤å›¾è¡¨
                </button>
            </div>
            <div class="chart-container" id="area-chart" style="height: 400px;"></div>
            <div id="area-ai-insight" class="ai-insight" style="display: none;"></div>
        </div>

        <!-- ä»·æ ¼å°æç´å›¾ - ä»…æŠ•èµ„é¡¾é—®å’Œæ”¹å–„å‹è´­æˆ¿è€…å¯è§ -->
        <div class="analysis-section role-filter" data-hide-for="first_time_buyer">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">ğŸ» ä»·æ ¼åˆ†å¸ƒå°æç´å›¾</h2>
                <button onclick="analyzeChart('violin')" style="
                    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                    color: white;
                    border: none;
                    padding: 8px 20px;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 0.9em;
                    font-weight: 600;
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ğŸ¤– AIåˆ†ææ­¤å›¾è¡¨
                </button>
            </div>
            <div id="price-violin" style="width: 100%; height: 400px;"></div>
            <div id="violin-ai-insight" style="display: none; margin-top: 20px;"></div>
        </div>
        
        <!-- åŒºåŸŸä»·æ ¼çƒ­åŠ›å›¾ - æ‰€æœ‰è§’è‰²å¯è§ -->
        <div class="analysis-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">ğŸ—ºï¸ åŒºåŸŸ-æ—¶é—´ä»·æ ¼çƒ­åŠ›å›¾</h2>
                <button onclick="analyzeChart('heatmap')" style="
                    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
                    color: white;
                    border: none;
                    padding: 8px 20px;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 0.9em;
                    font-weight: 600;
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ğŸ¤– AIåˆ†ææ­¤å›¾è¡¨
                </button>
            </div>
            <div id="district-heatmap" style="width: 100%; height: 600px;"></div>
            <div id="heatmap-ai-insight" style="display: none; margin-top: 20px;"></div>
        </div>
        
        <!-- ä»·æ ¼å˜åŒ–ç€‘å¸ƒå›¾ - ä»…æŠ•èµ„é¡¾é—®å’Œæ”¹å–„å‹è´­æˆ¿è€…å¯è§ -->
        <div class="analysis-section role-filter" data-hide-for="first_time_buyer">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">ğŸ“Š ä»·æ ¼å˜åŒ–å› ç´ æ‹†è§£</h2>
                <button onclick="analyzeChart('waterfall')" style="
                    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    color: white;
                    border: none;
                    padding: 8px 20px;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 0.9em;
                    font-weight: 600;
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ğŸ¤– AIåˆ†ææ­¤å›¾è¡¨
                </button>
            </div>
            <div id="price-waterfall" style="width: 100%; height: 450px;"></div>
            <div id="waterfall-ai-insight" style="display: none; margin-top: 20px;"></div>
        </div>
        
        <!-- æˆ·å‹åˆ†æ - æ‰€æœ‰è§’è‰²å¯è§ -->
        <div class="analysis-section" id="house-type-section" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">ğŸ  æˆ·å‹åˆ†æï¼ˆå‡ å®¤å‡ å…ï¼‰</h2>
                <button class="ai-analyze-btn" onclick="analyzeHouseTypeChart()" style="
                    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 0.85em;
                    transition: all 0.3s ease;
                ">
                    ğŸ¤– AIåˆ†ææ­¤å›¾è¡¨
                </button>
            </div>
            
            <!-- æˆ·å‹ç»Ÿè®¡å¡ç‰‡ -->
            <div id="house-type-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
            
            <!-- æˆ·å‹åˆ†å¸ƒå›¾è¡¨ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                <div class="chart-container">
                    <h3 style="text-align: center; color: #475569; font-size: 1.1em; margin-bottom: 15px;">ğŸ“Š æˆ·å‹åˆ†å¸ƒå æ¯”</h3>
                    <div id="house-type-distribution-chart" style="width: 100%; height: 350px;"></div>
                </div>
                <div class="chart-container">
                    <h3 style="text-align: center; color: #475569; font-size: 1.1em; margin-bottom: 15px;">ğŸ’° æˆ·å‹å¹³å‡ä»·æ ¼å¯¹æ¯”</h3>
                    <div id="house-type-price-chart" style="width: 100%; height: 350px;"></div>
                </div>
            </div>
            
            <!-- æŒ‰å®¤æ•°ç»Ÿè®¡ -->
            <div class="chart-container" style="margin-bottom: 25px;">
                <h3 style="text-align: center; color: #475569; font-size: 1.1em; margin-bottom: 15px;">ğŸ”¢ æŒ‰å®¤æ•°ç»Ÿè®¡åˆ†æ</h3>
                <div id="room-statistics-chart" style="width: 100%; height: 400px;"></div>
            </div>
            
            <!-- æˆ·å‹ä»·æ ¼è¶‹åŠ¿ -->
            <div class="chart-container">
                <h3 style="text-align: center; color: #475569; font-size: 1.1em; margin-bottom: 15px;">ğŸ“ˆ ä¸»æµæˆ·å‹ä»·æ ¼è¶‹åŠ¿</h3>
                <div id="house-type-trend-chart" style="width: 100%; height: 450px;"></div>
            </div>
            
            <!-- AIåˆ†æç»“æœ -->
            <div id="house-type-ai-insight" style="display: none; margin-top: 20px;"></div>
        </div>
        
        <!-- åŒºåŸŸæ·±åº¦åˆ†æ - æ‰€æœ‰è§’è‰²å¯è§ -->
        <div class="analysis-section">
            <h2>ğŸ—ºï¸ åŒºåŸŸæ·±åº¦åˆ†æï¼ˆTop 15ï¼‰</h2>
            <div class="table-wrapper">
                <table id="district-table"></table>
            </div>
        </div>

        <!-- å­£èŠ‚æ€§åˆ†æ - ä»…æŠ•èµ„é¡¾é—®å’Œæ”¹å–„å‹è´­æˆ¿è€…å¯è§ -->
        <div class="analysis-section role-filter" data-hide-for="first_time_buyer">
            <h2>ğŸŒ¸ å­£èŠ‚æ€§ç‰¹å¾åˆ†æ</h2>
            <div id="seasonal-analysis"></div>
        </div>

    </div>

    <div class="analysis-footer" style="text-align: center; padding: 30px; color: #64748b; font-size: 0.9em;">
        <p>æ•°æ®æ¥æºï¼šè´å£³æ‰¾æˆ¿ | åˆ†ææ—¶é—´ï¼š<span id="analysis-time"></span></p>
        <p>âš ï¸ æœ¬æŠ¥å‘Šä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- å›¾è¡¨åº“ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    const cityNameEn = '{{ city_name_en }}';
    const cityName = '{{ city_name }}';
</script>
<script src="{{ url_for('static', filename='js/user_role.js') }}"></script>
<script src="{{ url_for('static', filename='js/chart_ai.js') }}"></script>
<script src="{{ url_for('static', filename='js/echarts_renderer.js') }}"></script>
<script src="{{ url_for('static', filename='js/quick_insight.js') }}"></script>
<script src="{{ url_for('static', filename='js/analysis.js') }}"></script>

<script>
    function toggleIndexExplanation() {
        const explanation = document.getElementById('index-explanation');
        explanation.style.display = explanation.style.display === 'none' ? 'block' : 'none';
    }

    // æ ¹æ®ç”¨æˆ·è§’è‰²è¿‡æ»¤å†…å®¹
    async function applyRoleFilter() {
        const role = await ensureRoleLoaded();
        console.log('[Analysis] å½“å‰ç”¨æˆ·è§’è‰²:', role);
        
        // æ›´æ–°è§’è‰²å¾½ç« æ˜¾ç¤º
        const roleBadge = document.getElementById('user-role-badge');
        if (roleBadge) {
            const roleNames = {
                'investment_advisor': 'ğŸ’¼ æŠ•èµ„é¡¾é—®',
                'first_time_buyer': 'ğŸ  é¦–æ¬¡è´­æˆ¿è€…',
                'upgrader': 'ğŸ¡ æ”¹å–„å‹è´­æˆ¿è€…'
            };
            roleBadge.textContent = roleNames[role] || role;
        }
        
        // æ ¹æ®è§’è‰²éšè—ä¸éœ€è¦çš„å†…å®¹
        const hideElements = document.querySelectorAll('.role-filter');
        hideElements.forEach(el => {
            const hideFor = el.getAttribute('data-hide-for');
            if (hideFor && hideFor.includes(role)) {
                el.style.display = 'none';
            } else {
                el.style.display = 'block';
            }
        });
    }
    
    // Markdown æ¸²æŸ“å‡½æ•°
    function renderMarkdown(text) {
        if (!text) return '';
        let html = text;
        
        // 1. å…ˆå¤„ç†æ ‡é¢˜ï¼ˆå¸¦åŠ ç²—çš„æ ‡é¢˜ï¼‰
        html = html.replace(/^### \*\*(.+?)\*\*$/gm, '<h4 style="color: #fbbf24; margin: 18px 0 10px 0; font-size: 1.1em; font-weight: 700;">$1</h4>');
        html = html.replace(/^### (.+)$/gm, '<h4 style="color: #fbbf24; margin: 18px 0 10px 0; font-size: 1.1em; font-weight: 600;">$1</h4>');
        html = html.replace(/^## \*\*(.+?)\*\*$/gm, '<h3 style="color: #fde047; margin: 22px 0 12px 0; font-size: 1.2em; font-weight: 700;">$1</h3>');
        html = html.replace(/^## (.+)$/gm, '<h3 style="color: #fde047; margin: 22px 0 12px 0; font-size: 1.2em; font-weight: 600;">$1</h3>');
        
        // 2. åŠ ç²— **text**
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong style="color: #fde047; font-weight: 700;">$1</strong>');
        
        // 3. æ•°å­—åˆ—è¡¨
        html = html.replace(/^(\d+)\.\s+(.+)$/gm, '<div style="margin: 10px 0; padding-left: 5px;"><span style="color: #fbbf24; font-weight: 600;">$1.</span> $2</div>');
        
        // 4. æ— åºåˆ—è¡¨
        html = html.replace(/^[-*]\s+(.+)$/gm, '<li style="margin: 8px 0; margin-left: 20px; list-style: disc;">$1</li>');
        
        // 5. æ®µè½å¤„ç†
        const lines = html.split('\n');
        html = lines.map(line => {
            const trimmed = line.trim();
            if (!trimmed) return '';
            if (trimmed.startsWith('<')) return trimmed;
            return `<p style="margin: 12px 0; line-height: 1.85;">${trimmed}</p>`;
        }).filter(line => line).join('');
        
        return html;
    }
    
    // åŠ è½½ AI æ¦‚è§ˆï¼ˆæµå¼ï¼‰
    async function loadCityAIOverview() {
        const contentDiv = document.getElementById('city-ai-overview-content');
        contentDiv.innerHTML = '<p style="opacity: 0.8; text-align: center;">ğŸ¤– AIæ­£åœ¨åˆ†æä¸­...</p>';
        
        const role = await ensureRoleLoaded() || 'investment_advisor';
        console.log('[Analysis] åŠ è½½AIæ¦‚è§ˆï¼Œè§’è‰²:', role);
        
        const eventSource = new EventSource(`/api/city/${cityNameEn}/ai-overview-stream?role=${role}`);
        let fullText = '';
        
        eventSource.onmessage = function(event) {
            if (event.data === '[DONE]') {
                eventSource.close();
                return;
            }
            
            try {
                const data = JSON.parse(event.data);
                
                if (data.error) {
                    contentDiv.innerHTML = `<p style="opacity: 0.8;">âŒ ${data.error}</p>`;
                    eventSource.close();
                    return;
                }
                
                if (data.content) {
                    fullText += data.content;
                    contentDiv.innerHTML = renderMarkdown(fullText);
                }
            } catch (e) {
                console.error('è§£æSSEæ•°æ®é”™è¯¯:', e);
            }
        };
        
        eventSource.onerror = function(error) {
            console.error('SSEé”™è¯¯:', error);
            if (!fullText) {
                contentDiv.innerHTML = '<p style="opacity: 0.8;">AIåˆ†æåŠ è½½å¤±è´¥ï¼Œè¯·ç‚¹å‡»åˆ·æ–°é‡è¯•</p>';
            }
            eventSource.close();
        };
    }
    
    // åˆ·æ–°AIæ¦‚è§ˆ
    function refreshCityAIOverview() {
        loadCityAIOverview();
    }
    
    // ä¸€é”®AIæ´å¯Ÿ
    async function loadQuickAIInsight() {
        const role = await ensureRoleLoaded() || 'investment_advisor';
        if (typeof generateQuickInsight === 'function') {
            generateQuickInsight();
        } else {
            console.error('generateQuickInsight å‡½æ•°æœªå®šä¹‰');
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', async function() {
        await ensureRoleLoaded();
        applyRoleFilter();
        
        setTimeout(() => {
            loadCityAIOverview();
        }, 1000);
    });
    
    document.addEventListener('analysisDataLoaded', function() {
        applyRoleFilter();
    });
</script>
{% endblock %}
