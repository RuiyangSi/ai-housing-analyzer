{% extends "base_layout.html" %}

{% block title %}æ•°æ®è´¨é‡æ ¡éªŒ{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/analysis.css') }}">
<style>
    .page-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        padding: 40px;
        border-radius: 20px;
        margin-bottom: 30px;
        color: white;
        text-align: center;
    }
    
    .page-header h1 {
        margin: 0;
        font-size: 2.2em;
        font-weight: 800;
    }
    
    .page-header .subtitle {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 1.05em;
    }
    
    .validation-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }
    
    .summary-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .summary-card .icon {
        font-size: 2.5em;
        margin-bottom: 12px;
    }
    
    .summary-card .value {
        font-size: 2em;
        font-weight: 800;
        color: #1e293b;
    }
    
    .summary-card .label {
        color: #64748b;
        font-size: 0.95em;
        margin-top: 8px;
    }
    
    .summary-card.success .value { color: #10b981; }
    .summary-card.warning .value { color: #f59e0b; }
    .summary-card.info .value { color: #6366f1; }
    
    .validation-section {
        background: white;
        border-radius: 20px;
        padding: 28px;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f1f5f9;
    }
    
    .section-title {
        font-size: 1.4em;
        font-weight: 700;
        color: #1e293b;
    }
    
    .section-title .icon {
        margin-right: 10px;
    }
    
    .validation-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95em;
    }
    
    .validation-table th,
    .validation-table td {
        padding: 14px 16px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .validation-table th {
        background: #f8fafc;
        font-weight: 600;
        color: #475569;
        position: sticky;
        top: 0;
    }
    
    .validation-table tbody tr:hover {
        background: #f8fafc;
    }
    
    .validation-table .province-name {
        font-weight: 600;
        color: #1e293b;
    }
    
    .validation-table .number {
        font-family: 'JetBrains Mono', monospace;
        text-align: right;
    }
    
    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .progress-bar .fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    
    .progress-bar .fill.excellent { background: linear-gradient(90deg, #10b981, #34d399); }
    .progress-bar .fill.good { background: linear-gradient(90deg, #6366f1, #8b5cf6); }
    .progress-bar .fill.warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
    }
    
    .status-badge.excellent {
        background: #d1fae5;
        color: #059669;
    }
    
    .status-badge.good {
        background: #e0e7ff;
        color: #4f46e5;
    }
    
    .status-badge.warning {
        background: #fef3c7;
        color: #d97706;
    }
    
    .formula-box {
        background: linear-gradient(135deg, #1e293b, #334155);
        color: white;
        padding: 20px 24px;
        border-radius: 12px;
        margin: 20px 0;
        font-family: 'JetBrains Mono', monospace;
    }
    
    .formula-box .formula {
        font-size: 1.2em;
        text-align: center;
        margin: 10px 0;
    }
    
    .formula-box .description {
        font-size: 0.9em;
        opacity: 0.8;
        text-align: center;
    }
    
    .chart-container {
        height: 400px;
        margin-top: 20px;
    }
    
    .loading-overlay {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px;
        color: #64748b;
    }
    
    .loading-overlay .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #e2e8f0;
        border-top-color: #10b981;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .refresh-btn {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }
    
    .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .refresh-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    /* æ·±è‰²æ¨¡å¼ */
    body.dark-mode .validation-section,
    body.dark-mode .summary-card {
        background: #1e293b;
    }
    
    body.dark-mode .validation-table th {
        background: #0f172a;
        color: #94a3b8;
    }
    
    body.dark-mode .validation-table td {
        border-color: #334155;
    }
    
    body.dark-mode .validation-table tbody tr:hover {
        background: #334155;
    }
    
    body.dark-mode .section-title,
    body.dark-mode .summary-card .value,
    body.dark-mode .validation-table .province-name {
        color: #e2e8f0;
    }
    
    body.dark-mode .progress-bar {
        background: #334155;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ” æ•°æ®è´¨é‡æ ¡éªŒä¸­å¿ƒ</h1>
    <p class="subtitle">å®æ—¶ç›‘æ§æ•°æ®ä¸€è‡´æ€§ã€å®Œæ•´æ€§å’Œå‡†ç¡®æ€§</p>
</div>

<!-- åŠ è½½æç¤º -->
<div id="loading-container" class="validation-section">
    <div class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 20px;">æ­£åœ¨åˆ†ææ•°æ®è´¨é‡...</p>
    </div>
</div>

<!-- æ ¡éªŒç»“æœï¼ˆåŠ è½½åæ˜¾ç¤ºï¼‰ -->
<div id="validation-content" style="display: none;">
    <!-- æ±‡æ€»ç»Ÿè®¡ -->
    <div class="validation-summary" id="summary-cards">
        <!-- åŠ¨æ€å¡«å…… -->
    </div>
    
    <!-- æ ¡éªŒå…¬å¼è¯´æ˜ -->
    <div class="validation-section">
        <div class="section-header">
            <h2 class="section-title"><span class="icon">ğŸ“</span>æ ¡éªŒè§„åˆ™è¯´æ˜</h2>
        </div>
        <div class="formula-box">
            <div class="formula">æˆäº¤ä»·ï¼ˆä¸‡å…ƒï¼‰= é¢ç§¯ï¼ˆmÂ²ï¼‰Ã— å•ä»·ï¼ˆå…ƒ/mÂ²ï¼‰Ã· 10000</div>
            <div class="description">ä¸€è‡´æ€§æ ¡éªŒï¼šè®¡ç®—å®é™…æˆäº¤ä»·ä¸é¢„æœŸæˆäº¤ä»·çš„è¯¯å·®æ¯”ä¾‹</div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 20px;">
            <div style="padding: 16px; background: #f0fdf4; border-radius: 12px; border-left: 4px solid #10b981;">
                <strong style="color: #059669;">âœ… ä¸€è‡´æ€§æ ¡éªŒ</strong>
                <p style="margin: 8px 0 0; color: #047857; font-size: 0.9em;">æˆäº¤ä»·ä¸å•ä»·Ã—é¢ç§¯çš„è®¡ç®—è¯¯å·® â‰¤ 50%</p>
            </div>
            <div style="padding: 16px; background: #fef3c7; border-radius: 12px; border-left: 4px solid #f59e0b;">
                <strong style="color: #d97706;">ğŸ“Š å¼‚å¸¸å€¼è¿‡æ»¤</strong>
                <p style="margin: 8px 0 0; color: #b45309; font-size: 0.9em;">æˆäº¤ä»·: 10-5000ä¸‡ | å•ä»·: 1000-300000å…ƒ/ã¡ | é¢ç§¯: 10-500ã¡</p>
            </div>
            <div style="padding: 16px; background: #e0e7ff; border-radius: 12px; border-left: 4px solid #6366f1;">
                <strong style="color: #4f46e5;">ğŸ”„ å»é‡å¤„ç†</strong>
                <p style="margin: 8px 0 0; color: #4338ca; font-size: 0.9em;">åŸºäºå°åŒºã€æˆ·å‹ã€é¢ç§¯ã€æ—¥æœŸã€æˆäº¤ä»·å»é‡</p>
            </div>
        </div>
    </div>
    
    <!-- å„çœä»½æ ¡éªŒè¯¦æƒ… -->
    <div class="validation-section">
        <div class="section-header">
            <h2 class="section-title"><span class="icon">ğŸ“‹</span>å„çœä»½æ•°æ®ä¸€è‡´æ€§æŠ¥å‘Š</h2>
            <button class="refresh-btn" onclick="loadValidationData()" id="refresh-btn">
                <span>ğŸ”„</span> åˆ·æ–°æ•°æ®
            </button>
        </div>
        <div style="overflow-x: auto;">
            <table class="validation-table" id="validation-table">
                <thead>
                    <tr>
                        <th>çœä»½</th>
                        <th style="text-align: right;">æ•°æ®é‡</th>
                        <th style="text-align: right;">å¹³å‡è¯¯å·®</th>
                        <th style="text-align: right;">æœ€å¤§è¯¯å·®</th>
                        <th style="width: 200px;">&lt;1% å æ¯”</th>
                        <th style="text-align: right;">&lt;5% å æ¯”</th>
                        <th>è´¨é‡ç­‰çº§</th>
                    </tr>
                </thead>
                <tbody id="validation-tbody">
                    <!-- åŠ¨æ€å¡«å…… -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- è¯¯å·®åˆ†å¸ƒå›¾è¡¨ -->
    <div class="validation-section">
        <div class="section-header">
            <h2 class="section-title"><span class="icon">ğŸ“Š</span>æ•°æ®è´¨é‡å¯è§†åŒ–</h2>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h4 style="margin-bottom: 15px; color: #475569;">å„çœä»½å¹³å‡è¯¯å·®å¯¹æ¯”</h4>
                <div id="error-chart" class="chart-container"></div>
            </div>
            <div>
                <h4 style="margin-bottom: 15px; color: #475569;">æ•°æ®é‡åˆ†å¸ƒ</h4>
                <div id="count-chart" class="chart-container"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
let validationData = null;
let errorChart = null;
let countChart = null;

async function loadValidationData() {
    const refreshBtn = document.getElementById('refresh-btn');
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<span>â³</span> åŠ è½½ä¸­...';
    }
    
    try {
        const response = await fetch('/api/data-validation');
        validationData = await response.json();
        
        document.getElementById('loading-container').style.display = 'none';
        document.getElementById('validation-content').style.display = 'block';
        
        renderSummary(validationData);
        renderTable(validationData.provinces);
        renderCharts(validationData.provinces);
        
    } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        document.getElementById('loading-container').innerHTML = `
            <div class="loading-overlay">
                <p style="color: #ef4444;">âŒ åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
            </div>
        `;
    } finally {
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<span>ğŸ”„</span> åˆ·æ–°æ•°æ®';
        }
    }
}

function renderSummary(data) {
    const container = document.getElementById('summary-cards');
    container.innerHTML = `
        <div class="summary-card info">
            <div class="icon">ğŸ“Š</div>
            <div class="value">${data.total_count.toLocaleString()}</div>
            <div class="label">æ€»æ•°æ®é‡</div>
        </div>
        <div class="summary-card info">
            <div class="icon">ğŸ—ºï¸</div>
            <div class="value">${data.province_count}</div>
            <div class="label">çœä»½æ•°é‡</div>
        </div>
        <div class="summary-card success">
            <div class="icon">âœ…</div>
            <div class="value">${data.avg_error.toFixed(2)}%</div>
            <div class="label">å¹³å‡è¯¯å·®</div>
        </div>
        <div class="summary-card success">
            <div class="icon">ğŸ¯</div>
            <div class="value">${data.lt_1_percent.toFixed(1)}%</div>
            <div class="label">è¯¯å·®&lt;1%å æ¯”</div>
        </div>
        <div class="summary-card success">
            <div class="icon">ğŸ“ˆ</div>
            <div class="value">${data.lt_5_percent.toFixed(1)}%</div>
            <div class="label">è¯¯å·®&lt;5%å æ¯”</div>
        </div>
    `;
}

function renderTable(provinces) {
    const tbody = document.getElementById('validation-tbody');
    tbody.innerHTML = provinces.map(p => {
        let statusClass = 'excellent';
        let statusText = 'ä¼˜ç§€';
        if (p.avg_error > 0.5) {
            statusClass = 'good';
            statusText = 'è‰¯å¥½';
        }
        if (p.avg_error > 1) {
            statusClass = 'warning';
            statusText = 'ä¸€èˆ¬';
        }
        
        let progressClass = 'excellent';
        if (p.lt_1_percent < 90) progressClass = 'good';
        if (p.lt_1_percent < 70) progressClass = 'warning';
        
        return `
            <tr>
                <td class="province-name">${p.province}</td>
                <td class="number">${p.count.toLocaleString()}</td>
                <td class="number">${p.avg_error.toFixed(2)}%</td>
                <td class="number">${p.max_error.toFixed(2)}%</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="progress-bar" style="flex: 1;">
                            <div class="fill ${progressClass}" style="width: ${p.lt_1_percent}%;"></div>
                        </div>
                        <span class="number" style="min-width: 50px;">${p.lt_1_percent.toFixed(1)}%</span>
                    </div>
                </td>
                <td class="number">${p.lt_5_percent.toFixed(1)}%</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            </tr>
        `;
    }).join('');
}

function renderCharts(provinces) {
    // è¯¯å·®å¯¹æ¯”å›¾
    const errorContainer = document.getElementById('error-chart');
    if (errorChart) errorChart.dispose();
    errorChart = echarts.init(errorContainer);
    
    const isDark = document.body.classList.contains('dark-mode');
    const textColor = isDark ? '#e2e8f0' : '#475569';
    
    const sortedByError = [...provinces].sort((a, b) => a.avg_error - b.avg_error);
    
    errorChart.setOption({
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: params => `${params[0].name}<br/>å¹³å‡è¯¯å·®: ${params[0].value.toFixed(3)}%`
        },
        grid: { left: 80, right: 20, top: 20, bottom: 60 },
        xAxis: {
            type: 'category',
            data: sortedByError.map(p => p.province),
            axisLabel: { rotate: 45, color: textColor, fontSize: 11 },
            axisLine: { lineStyle: { color: isDark ? '#475569' : '#e2e8f0' } }
        },
        yAxis: {
            type: 'value',
            name: 'å¹³å‡è¯¯å·® (%)',
            nameTextStyle: { color: textColor },
            axisLabel: { color: textColor, formatter: '{value}%' },
            axisLine: { lineStyle: { color: isDark ? '#475569' : '#e2e8f0' } },
            splitLine: { lineStyle: { color: isDark ? '#334155' : '#f1f5f9' } }
        },
        series: [{
            type: 'bar',
            data: sortedByError.map(p => ({
                value: p.avg_error,
                itemStyle: {
                    color: p.avg_error < 0.3 ? '#10b981' : p.avg_error < 0.5 ? '#6366f1' : '#f59e0b'
                }
            })),
            barWidth: '60%'
        }]
    });
    
    // æ•°æ®é‡åˆ†å¸ƒå›¾
    const countContainer = document.getElementById('count-chart');
    if (countChart) countChart.dispose();
    countChart = echarts.init(countContainer);
    
    const sortedByCount = [...provinces].sort((a, b) => b.count - a.count).slice(0, 15);
    
    countChart.setOption({
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: params => `${params[0].name}<br/>æ•°æ®é‡: ${params[0].value.toLocaleString()} æ¡`
        },
        grid: { left: 80, right: 20, top: 20, bottom: 60 },
        xAxis: {
            type: 'category',
            data: sortedByCount.map(p => p.province),
            axisLabel: { rotate: 45, color: textColor, fontSize: 11 },
            axisLine: { lineStyle: { color: isDark ? '#475569' : '#e2e8f0' } }
        },
        yAxis: {
            type: 'value',
            name: 'æ•°æ®é‡',
            nameTextStyle: { color: textColor },
            axisLabel: { color: textColor, formatter: val => (val / 10000).toFixed(1) + 'ä¸‡' },
            axisLine: { lineStyle: { color: isDark ? '#475569' : '#e2e8f0' } },
            splitLine: { lineStyle: { color: isDark ? '#334155' : '#f1f5f9' } }
        },
        series: [{
            type: 'bar',
            data: sortedByCount.map(p => p.count),
            itemStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: '#6366f1' },
                    { offset: 1, color: '#8b5cf6' }
                ])
            },
            barWidth: '60%'
        }]
    });
    
    window.addEventListener('resize', () => {
        errorChart && errorChart.resize();
        countChart && countChart.resize();
    });
}

// ç›‘å¬æ·±è‰²æ¨¡å¼åˆ‡æ¢
const observer = new MutationObserver(() => {
    if (validationData) {
        renderCharts(validationData.provinces);
    }
});
observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });

// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
document.addEventListener('DOMContentLoaded', loadValidationData);
</script>
{% endblock %}

